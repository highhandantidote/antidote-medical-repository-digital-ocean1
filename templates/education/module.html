{% extends 'base.html' %}

{% block title %}{{ module.title }} - Antidote Education Hub{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb" class="mt-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('education.learn_home') }}">Education Hub</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('education.browse_modules') }}">Browse Modules</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ module.title }}</li>
        </ol>
    </nav>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i> {{ error }}
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-3">{{ module.title }}</h1>
            
            <div class="d-flex flex-wrap mb-3">
                <span class="badge bg-info me-2">{{ module.estimated_minutes }} min</span>
                <span class="badge {% if module.level <= 2 %}bg-success{% elif module.level <= 4 %}bg-warning{% else %}bg-danger{% endif %} me-2">
                    Level {{ module.level }}
                </span>
                {% if module.procedure %}
                <a href="{{ url_for('web.procedure_detail', procedure_id=module.procedure.id) }}" class="badge bg-secondary me-2 text-decoration-none">
                    {{ module.procedure.procedure_name }}
                </a>
                {% endif %}
                {% if module.category %}
                <span class="badge bg-secondary">{{ module.category.name }}</span>
                {% endif %}
            </div>
            
            <p class="lead">{{ module.description }}</p>
            
            {% if module_completed %}
            <div class="alert alert-success mb-4">
                <i class="fas fa-check-circle me-2"></i> You've successfully completed this module!
            </div>
            {% endif %}
        </div>
        
        <div class="col-md-4">
            <div class="card bg-dark border-info mb-4">
                <div class="card-header bg-info bg-opacity-25 text-info">
                    <h5 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>Module Progress</h5>
                </div>
                <div class="card-body">
                    {% if current_user.is_authenticated %}
                        {% if module_completed %}
                            <div class="text-center mb-3">
                                <div class="display-1 text-success"><i class="fas fa-medal"></i></div>
                                <h5 class="mt-2">Module Completed!</h5>
                                <p class="text-muted small">You've mastered this content</p>
                            </div>
                        {% else %}
                            <div class="progress mb-3" style="height: 10px;">
                                {% set total_quizzes = quizzes|length %}
                                {% set passed_quizzes = 0 %}
                                {% for quiz in quizzes %}
                                    {% if quiz.id in quiz_results and quiz_results[quiz.id].passed %}
                                        {% set passed_quizzes = passed_quizzes + 1 %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if total_quizzes > 0 %}
                                    {% set progress_percentage = (passed_quizzes / total_quizzes) * 100 %}
                                {% else %}
                                    {% set progress_percentage = 0 %}
                                {% endif %}
                                
                                <div class="progress-bar bg-info" role="progressbar" style="width: {{ progress_percentage }}%;" 
                                    aria-valuenow="{{ progress_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ progress_percentage|int }}%
                                </div>
                            </div>
                            <p class="small text-center text-muted mb-3">
                                Complete all quizzes to earn the module achievement
                            </p>
                        {% endif %}
                    {% else %}
                        <div class="text-center mb-3">
                            <p class="mb-3">Sign in to track your progress</p>
                            <a href="{{ url_for('web.login') }}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-sign-in-alt me-2"></i>Login
                            </a>
                        </div>
                    {% endif %}
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Quizzes</h6>
                        <span class="badge bg-secondary">{{ quizzes|length }}</span>
                    </div>
                    
                    {% for quiz in quizzes %}
                    <div class="d-flex justify-content-between align-items-center quiz-item mb-2 p-2 rounded
                        {% if current_user.is_authenticated and quiz.id in quiz_results and quiz_results[quiz.id].passed %}
                            bg-success bg-opacity-25
                        {% else %}
                            bg-dark border border-light
                        {% endif %}">
                        <div>
                            <span class="fw-bold">{{ quiz.title }}</span>
                            {% if current_user.is_authenticated and quiz.id in quiz_results %}
                                <div class="small text-muted">Score: {{ quiz_results[quiz.id].score }}%</div>
                            {% endif %}
                        </div>
                        <div>
                            {% if current_user.is_authenticated and quiz.id in quiz_results and quiz_results[quiz.id].passed %}
                                <i class="fas fa-check-circle text-success me-2"></i>
                            {% endif %}
                            <a href="{{ url_for('education.take_quiz', quiz_id=quiz.id) }}" class="btn btn-sm btn-outline-info">
                                {% if current_user.is_authenticated and quiz.id in quiz_results %}
                                    Retake Quiz
                                {% else %}
                                    Take Quiz
                                {% endif %}
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            {% if related_modules %}
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-dark">
                    <h5 class="mb-0"><i class="fas fa-link me-2"></i>Related Modules</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush bg-transparent">
                        {% for related in related_modules %}
                        <li class="list-group-item bg-transparent border-light">
                            <a href="{{ url_for('education.view_module', module_id=related.id) }}" class="text-decoration-none">
                                {{ related.title }}
                            </a>
                            <div class="d-flex mt-1">
                                <span class="badge bg-info me-2">{{ related.estimated_minutes }} min</span>
                                <span class="badge {% if related.level <= 2 %}bg-success{% elif related.level <= 4 %}bg-warning{% else %}bg-danger{% endif %}">
                                    Level {{ related.level }}
                                </span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Module Content -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card bg-dark border-light">
                <div class="card-header bg-dark">
                    <h3 class="mb-0"><i class="fas fa-book me-2"></i>Module Content</h3>
                </div>
                <div class="card-body">
                    <div class="module-content">
                        {{ module.content|safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quiz Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card bg-dark border-info">
                <div class="card-header bg-info bg-opacity-25 text-info">
                    <h3 class="mb-0"><i class="fas fa-question-circle me-2"></i>Knowledge Check</h3>
                </div>
                <div class="card-body">
                    {% if quizzes %}
                        <p class="lead">Test your knowledge by taking the quizzes for this module:</p>
                        
                        <div class="row">
                            {% for quiz in quizzes %}
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 bg-dark border-light hover-card">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ quiz.title }}</h5>
                                        <p class="text-muted small">{{ quiz.description }}</p>
                                        
                                        {% if current_user.is_authenticated and quiz.id in quiz_results %}
                                            <div class="d-flex align-items-center justify-content-between mb-3">
                                                <div>
                                                    <div class="mb-1">Your Score: <strong>{{ quiz_results[quiz.id].score }}%</strong></div>
                                                    <div class="progress" style="height: 8px; width: 120px;">
                                                        <div class="progress-bar {% if quiz_results[quiz.id].passed %}bg-success{% else %}bg-warning{% endif %}" 
                                                            style="width: {{ quiz_results[quiz.id].score }}%">
                                                        </div>
                                                    </div>
                                                </div>
                                                {% if quiz_results[quiz.id].passed %}
                                                    <span class="badge bg-success"><i class="fas fa-check me-1"></i>Passed</span>
                                                {% else %}
                                                    <span class="badge bg-warning"><i class="fas fa-times me-1"></i>Try Again</span>
                                                {% endif %}
                                            </div>
                                            <a href="{{ url_for('education.take_quiz', quiz_id=quiz.id) }}" class="btn btn-outline-info w-100">
                                                Retake Quiz
                                            </a>
                                        {% else %}
                                            <div class="text-muted small mb-3">
                                                <i class="fas fa-info-circle me-1"></i> Passing Score: {{ quiz.passing_score }}%
                                            </div>
                                            <a href="{{ url_for('education.take_quiz', quiz_id=quiz.id) }}" class="btn btn-outline-info w-100">
                                                <i class="fas fa-play me-2"></i>Start Quiz
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle me-2"></i>No quizzes are available for this module yet. Check back soon!
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="row mb-5">
        <div class="col-12 d-flex justify-content-between">
            <a href="{{ url_for('education.browse_modules') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Browse
            </a>
            
            {% if module.procedure %}
            <a href="{{ url_for('web.procedure_detail', procedure_id=module.procedure.id) }}" class="btn btn-outline-primary">
                <i class="fas fa-info-circle me-2"></i>View {{ module.procedure.procedure_name }} Details
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .module-content {
        font-size: 1.1rem;
        line-height: 1.6;
    }
    
    .module-content h2 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        color: #0dcaf0;
    }
    
    .module-content h3 {
        margin-top: 1.25rem;
        margin-bottom: 0.75rem;
        color: #0dcaf0;
    }
    
    .module-content ul, .module-content ol {
        margin-bottom: 1rem;
        padding-left: 1.5rem;
    }
    
    .module-content img {
        max-width: 100%;
        height: auto;
        margin: 1rem 0;
        border-radius: 0.5rem;
    }
    
    .module-content p {
        margin-bottom: 1rem;
    }
    
    .quiz-item {
        transition: background-color 0.3s ease;
    }
    
    .quiz-item:hover {
        background-color: rgba(255, 255, 255, 0.05) !important;
    }
    
    .hover-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        border-color: #0dcaf0 !important;
    }
</style>
{% endblock %}