{% extends 'base.html' %}

{% block title %}Availability | Doctor Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card bg-dark text-white mb-4">
                <div class="card-body">
                    <h4>Doctor Profile</h4>
                    <p>{{ doctor.name }}</p>
                    <p>â˜… {{ doctor.rating }} ({{ doctor.review_count }} reviews)</p>
                    <a href="#" class="btn btn-outline-primary">Edit Profile</a>

                    <h4 class="mt-4">Dashboard Menu</h4>
                    <ul class="list-group">
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_dashboard', doctor_id=doctor.id) }}" class="text-white">Overview</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_dashboard', doctor_id=doctor.id) }}#appointments" class="text-white">Appointments</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_leads', doctor_id=doctor.id) }}" class="text-white">Patient Leads</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_dashboard', doctor_id=doctor.id) }}#reviews" class="text-white">Reviews</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_procedures', doctor_id=doctor.id) }}" class="text-white">My Procedures</a></li>
                        <li class="list-group-item bg-dark text-white active"><a href="{{ url_for('web.doctor_availability', doctor_id=doctor.id) }}" class="text-white">Availability</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_gallery', doctor_id=doctor.id) }}" class="text-white">Gallery</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_community', doctor_id=doctor.id) }}" class="text-white">Community</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_verification', doctor_id=doctor.id) }}" class="text-white">Verification <span class="badge bg-warning">NEW</span></a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9">
            <!-- Weekly Schedule -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Weekly Schedule</h3>
                    <div>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editScheduleModal">
                            <i class="fas fa-edit"></i> Edit Schedule
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if availability %}
                        <div class="table-responsive">
                            <table class="table table-dark table-bordered">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Morning (9AM-12PM)</th>
                                        <th>Afternoon (12PM-4PM)</th>
                                        <th>Evening (4PM-8PM)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                                    {% for day in days %}
                                        <tr>
                                            <td>{{ day }}</td>
                                            {% set day_availability = availability|selectattr('day_of_week', 'equalto', day)|first %}
                                            
                                            {% if day_availability %}
                                                {% if day_availability.start_time and day_availability.start_time.hour <= 12 %}
                                                    <td class="bg-success-subtle text-white">
                                                        <i class="fas fa-check-circle text-success"></i> Available
                                                        <div class="small">{{ day_availability.start_time.strftime('%I:%M %p') }} - 
                                                        {% if day_availability.end_time and day_availability.end_time.hour <= 12 %}
                                                            {{ day_availability.end_time.strftime('%I:%M %p') }}
                                                        {% else %}
                                                            12:00 PM
                                                        {% endif %}
                                                        </div>
                                                    </td>
                                                {% else %}
                                                    <td class="bg-danger-subtle text-white">
                                                        <i class="fas fa-times-circle text-danger"></i> Unavailable
                                                    </td>
                                                {% endif %}
                                                
                                                {% if day_availability.start_time and day_availability.start_time.hour <= 16 and day_availability.end_time and day_availability.end_time.hour >= 12 %}
                                                    <td class="bg-success-subtle text-white">
                                                        <i class="fas fa-check-circle text-success"></i> Available
                                                        <div class="small">
                                                        {% if day_availability.start_time.hour < 12 %}
                                                            12:00 PM - 
                                                        {% else %}
                                                            {{ day_availability.start_time.strftime('%I:%M %p') }} - 
                                                        {% endif %}
                                                        {% if day_availability.end_time.hour <= 16 %}
                                                            {{ day_availability.end_time.strftime('%I:%M %p') }}
                                                        {% else %}
                                                            4:00 PM
                                                        {% endif %}
                                                        </div>
                                                    </td>
                                                {% else %}
                                                    <td class="bg-danger-subtle text-white">
                                                        <i class="fas fa-times-circle text-danger"></i> Unavailable
                                                    </td>
                                                {% endif %}
                                                
                                                {% if day_availability.end_time and day_availability.end_time.hour >= 16 %}
                                                    <td class="bg-success-subtle text-white">
                                                        <i class="fas fa-check-circle text-success"></i> Available
                                                        <div class="small">
                                                        {% if day_availability.start_time.hour < 16 %}
                                                            4:00 PM - 
                                                        {% else %}
                                                            {{ day_availability.start_time.strftime('%I:%M %p') }} - 
                                                        {% endif %}
                                                        {{ day_availability.end_time.strftime('%I:%M %p') }}
                                                        </div>
                                                    </td>
                                                {% else %}
                                                    <td class="bg-danger-subtle text-white">
                                                        <i class="fas fa-times-circle text-danger"></i> Unavailable
                                                    </td>
                                                {% endif %}
                                            {% else %}
                                                <td class="bg-danger-subtle text-white">
                                                    <i class="fas fa-times-circle text-danger"></i> Unavailable
                                                </td>
                                                <td class="bg-danger-subtle text-white">
                                                    <i class="fas fa-times-circle text-danger"></i> Unavailable
                                                </td>
                                                <td class="bg-danger-subtle text-white">
                                                    <i class="fas fa-times-circle text-danger"></i> Unavailable
                                                </td>
                                            {% endif %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> You haven't set up your availability yet. Set your regular working hours to allow patients to book appointments.
                        </div>
                        <div class="text-center my-4">
                            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#editScheduleModal">
                                <i class="fas fa-calendar-plus me-2"></i> Set Your Availability
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Special Dates -->
            <div class="card bg-dark text-white">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Special Dates</h4>
                    <div>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSpecialDateModal">
                            <i class="fas fa-plus"></i> Add Special Date
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card bg-dark border-warning mb-3">
                                <div class="card-header bg-warning-subtle text-white">
                                    <h5 class="mb-0">Upcoming Time Off</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        {% if special_dates and special_dates.time_off %}
                                            {% for date in special_dates.time_off %}
                                                <li class="list-group-item bg-dark text-white">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong>{{ date.date.strftime('%b %d, %Y') }}</strong>
                                                            <div class="text-muted small">
                                                                {{ date.reason if date.reason else "Time Off" }}
                                                            </div>
                                                        </div>
                                                        <button class="btn btn-sm btn-outline-danger" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#deleteSpecialDateModal" 
                                                            data-date-id="{{ date.id }}">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        {% else %}
                                            <li class="list-group-item bg-dark text-white text-center">
                                                No upcoming time off scheduled
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-dark border-info mb-3">
                                <div class="card-header bg-info-subtle text-white">
                                    <h5 class="mb-0">Special Working Hours</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        {% if special_dates and special_dates.extended_hours %}
                                            {% for date in special_dates.extended_hours %}
                                                <li class="list-group-item bg-dark text-white">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong>{{ date.date.strftime('%b %d, %Y') }}</strong>
                                                            <div class="text-muted small">
                                                                {{ date.start_time.strftime('%I:%M %p') }} - {{ date.end_time.strftime('%I:%M %p') }}
                                                            </div>
                                                        </div>
                                                        <button class="btn btn-sm btn-outline-danger" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#deleteSpecialDateModal" 
                                                            data-date-id="{{ date.id }}">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </li>
                                            {% endfor %}
                                        {% else %}
                                            <li class="list-group-item bg-dark text-white text-center">
                                                No special working hours scheduled
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="editScheduleModalLabel">Edit Weekly Schedule</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('web.update_availability', doctor_id=doctor.id) }}" method="POST" id="scheduleForm">
                    {% set days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                    
                    {% for day in days %}
                        <div class="card bg-dark border-secondary mb-3">
                            <div class="card-header">{{ day }}</div>
                            <div class="card-body">
                                {% set day_availability = availability|selectattr('day_of_week', 'equalto', day)|first %}
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="{{ day|lower }}Available" 
                                        name="{{ day|lower }}_available" 
                                        {% if day_availability %}checked{% endif %}
                                        onchange="toggleTimeInputs('{{ day|lower }}')">
                                    <label class="form-check-label" for="{{ day|lower }}Available">
                                        Available on {{ day }}
                                    </label>
                                </div>
                                
                                <div class="row time-inputs {{ 'collapse' if not day_availability else '' }}" id="{{ day|lower }}TimeInputs">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ day|lower }}StartTime" class="form-label">Start Time</label>
                                            <input type="time" class="form-control" 
                                                id="{{ day|lower }}StartTime" 
                                                name="{{ day|lower }}_start_time" 
                                                value="{{ day_availability.start_time.strftime('%H:%M') if day_availability and day_availability.start_time else '09:00' }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ day|lower }}EndTime" class="form-label">End Time</label>
                                            <input type="time" class="form-control" 
                                                id="{{ day|lower }}EndTime" 
                                                name="{{ day|lower }}_end_time" 
                                                value="{{ day_availability.end_time.strftime('%H:%M') if day_availability and day_availability.end_time else '17:00' }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    
                    <div class="mb-3">
                        <label for="appointmentDuration" class="form-label">Default Appointment Duration</label>
                        <select class="form-select" id="appointmentDuration" name="appointment_duration">
                            <option value="15" {% if doctor.appointment_duration == 15 %}selected{% endif %}>15 minutes</option>
                            <option value="30" {% if not doctor.appointment_duration or doctor.appointment_duration == 30 %}selected{% endif %}>30 minutes</option>
                            <option value="45" {% if doctor.appointment_duration == 45 %}selected{% endif %}>45 minutes</option>
                            <option value="60" {% if doctor.appointment_duration == 60 %}selected{% endif %}>1 hour</option>
                            <option value="90" {% if doctor.appointment_duration == 90 %}selected{% endif %}>1.5 hours</option>
                            <option value="120" {% if doctor.appointment_duration == 120 %}selected{% endif %}>2 hours</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bufferTime" class="form-label">Buffer Time Between Appointments</label>
                        <select class="form-select" id="bufferTime" name="buffer_time">
                            <option value="0" {% if doctor.buffer_time == 0 %}selected{% endif %}>No buffer</option>
                            <option value="5" {% if not doctor.buffer_time or doctor.buffer_time == 5 %}selected{% endif %}>5 minutes</option>
                            <option value="10" {% if doctor.buffer_time == 10 %}selected{% endif %}>10 minutes</option>
                            <option value="15" {% if doctor.buffer_time == 15 %}selected{% endif %}>15 minutes</option>
                            <option value="30" {% if doctor.buffer_time == 30 %}selected{% endif %}>30 minutes</option>
                        </select>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="allowOnlineMeetings" name="allow_online_meetings" {% if doctor.allow_online_meetings %}checked{% endif %}>
                        <label class="form-check-label" for="allowOnlineMeetings">
                            Allow online video consultations
                        </label>
                    </div>
                    
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Special Date Modal -->
<div class="modal fade" id="addSpecialDateModal" tabindex="-1" aria-labelledby="addSpecialDateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="addSpecialDateModalLabel">Add Special Date</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('web.add_special_date', doctor_id=doctor.id) }}" method="POST">
                    <div class="mb-3">
                        <label for="specialDateType" class="form-label">Type</label>
                        <select class="form-select" id="specialDateType" name="date_type" onchange="toggleSpecialDateFields()">
                            <option value="time_off">Time Off</option>
                            <option value="extended_hours">Special Working Hours</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="specialDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="specialDate" name="date" required>
                    </div>
                    
                    <div id="timeOffFields">
                        <div class="mb-3">
                            <label for="reason" class="form-label">Reason (optional)</label>
                            <input type="text" class="form-control" id="reason" name="reason" placeholder="e.g., Vacation, Conference">
                        </div>
                    </div>
                    
                    <div id="hourFields" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="specialStartTime" class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="specialStartTime" name="start_time" value="09:00">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="specialEndTime" class="form-label">End Time</label>
                                    <input type="time" class="form-control" id="specialEndTime" name="end_time" value="17:00">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Special Date</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Special Date Modal -->
<div class="modal fade" id="deleteSpecialDateModal" tabindex="-1" aria-labelledby="deleteSpecialDateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteSpecialDateModalLabel">Delete Special Date</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this special date?</p>
                <form action="{{ url_for('web.delete_special_date', doctor_id=doctor.id) }}" method="POST" id="deleteSpecialDateForm">
                    <input type="hidden" name="date_id" id="deleteSpecialDateId">
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleTimeInputs(day) {
        const checkbox = document.getElementById(`${day}Available`);
        const timeInputs = document.getElementById(`${day}TimeInputs`);
        
        if (checkbox.checked) {
            timeInputs.classList.remove('collapse');
        } else {
            timeInputs.classList.add('collapse');
        }
    }
    
    function toggleSpecialDateFields() {
        const dateType = document.getElementById('specialDateType').value;
        const timeOffFields = document.getElementById('timeOffFields');
        const hourFields = document.getElementById('hourFields');
        
        if (dateType === 'time_off') {
            timeOffFields.style.display = 'block';
            hourFields.style.display = 'none';
        } else {
            timeOffFields.style.display = 'none';
            hourFields.style.display = 'block';
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize date picker with current date
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        document.getElementById('specialDate').value = formattedDate;
        
        // Handle delete special date
        const deleteModal = document.getElementById('deleteSpecialDateModal');
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const dateId = button.getAttribute('data-date-id');
                document.getElementById('deleteSpecialDateId').value = dateId;
            });
        }
    });
</script>
{% endblock %}