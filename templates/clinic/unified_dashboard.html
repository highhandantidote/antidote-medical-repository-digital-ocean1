{% extends "base.html" %}

{% block title %}Clinic Dashboard - {{ clinic.name }}{% endblock %}

{% block head %}
{{ super() }}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0">{{ clinic.name }} Dashboard</h1>
            <p class="text-muted">Manage your clinic profile, packages, doctors, and leads</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('clinic.clinic_detail', slug=clinic.id) }}" class="btn btn-outline-primary" target="_blank">
                <i class="fas fa-eye me-2"></i>Preview Profile
            </a>
        </div>
    </div>

    <!-- Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ metrics.total_leads }}</h4>
                            <p class="mb-0">Total Leads</p>
                        </div>
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ metrics.pending_leads }}</h4>
                            <p class="mb-0">Pending</p>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ metrics.monthly_leads }}</h4>
                            <p class="mb-0">This Month</p>
                        </div>
                        <i class="fas fa-calendar fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">₹{{ metrics.credit_balance|int }}</h4>
                            <p class="mb-0">Credits</p>
                        </div>
                        <i class="fas fa-wallet fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ metrics.package_count }}</h4>
                            <p class="mb-0">Packages</p>
                        </div>
                        <i class="fas fa-box fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ metrics.doctor_count }}</h4>
                            <p class="mb-0">Doctors</p>
                        </div>
                        <i class="fas fa-user-md fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="dashboardTabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#leads">Leads Management</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#profile">Profile Settings</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#packages">Package Management</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#doctors">Doctor Management</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#highlights">Clinic Highlights</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#specialties">Specialties</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#popular-procedures">Popular Procedures</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#reviews">Google Reviews</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#contact">Contact Settings</a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Leads Management Tab -->
        <div class="tab-pane fade show active" id="leads">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Leads</h5>
                </div>
                <div class="card-body">
                    {% if recent_leads %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Contact Info</th>
                                    <th>Procedure</th>
                                    <th>Price Range</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lead in recent_leads %}
                                <tr>
                                    <td>{{ lead.created_at.strftime('%d %b %Y') if lead.created_at else 'N/A' }}</td>
                                    <td>{{ lead.contact_info[:50] }}...</td>
                                    <td>{{ lead.procedure_name or 'General Inquiry' }}</td>
                                    <td>
                                        {% if lead.min_cost and lead.max_cost %}
                                            ₹{{ lead.min_cost|int }} - ₹{{ lead.max_cost|int }}
                                        {% else %}
                                            Contact for pricing
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'warning' if lead.status == 'new' else 'success' }}">
                                            {{ lead.status|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="contactLead('{{ lead.contact_info }}')">
                                            Contact
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5>No leads yet</h5>
                        <p class="text-muted">Leads will appear here when patients contact your clinic</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Profile Settings Tab -->
        <div class="tab-pane fade" id="profile">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Basic Profile Information</h5>
                </div>
                <div class="card-body">
                    <form id="profileForm" onsubmit="updateProfile(event)">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Clinic Name</label>
                                    <input type="text" class="form-control" name="name" value="{{ clinic.name }}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Address</label>
                                    <textarea class="form-control" name="address" rows="3" required>{{ clinic.address or '' }}</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" name="city" value="{{ clinic.city or '' }}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">State</label>
                                    <input type="text" class="form-control" name="state" value="{{ clinic.state or '' }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Working Hours</label>
                                    <input type="text" class="form-control" name="working_hours" value="{{ clinic.working_hours or '' }}" placeholder="e.g., Mon-Fri: 9:00 AM - 6:00 PM">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Contact Number</label>
                                    <input type="tel" class="form-control" name="contact_number" value="{{ clinic.contact_number or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">WhatsApp Number</label>
                                    <input type="tel" class="form-control" name="whatsapp_number" value="{{ clinic.whatsapp_number or '' }}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" name="description" rows="3" placeholder="Brief description of your clinic">{{ clinic.description or '' }}</textarea>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Profile</button>
                    </form>
                </div>
            </div>

            <!-- Image Upload Section -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Clinic Images</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Profile Image</h6>
                            <div class="mb-3">
                                {% if clinic.profile_image %}
                                <div class="current-image mb-2">
                                    <img src="{{ clinic.profile_image }}" alt="Current Profile Image" class="img-thumbnail" style="max-width: 200px; height: auto;">
                                </div>
                                {% endif %}
                                <form id="profileImageForm" enctype="multipart/form-data" onsubmit="uploadProfileImage(event)">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <div class="input-group mb-2">
                                        <input type="file" class="form-control" name="profile_image" accept="image/*" onchange="previewClinicImage(this, 'clinicProfilePreview')">
                                        <button type="submit" class="btn btn-primary">Upload</button>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Or provide image URL:</small>
                                        <div class="input-group input-group-sm">
                                            <input type="url" class="form-control" name="profile_image_url" placeholder="https://example.com/clinic-logo.jpg" onchange="previewClinicImageFromURL(this, 'clinicProfilePreview')">
                                            <button type="button" class="btn btn-outline-secondary" onclick="uploadFromURL('profile')">Use URL</button>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <img id="clinicProfilePreview" src="{{ clinic.profile_image or '/static/images/default-clinic.jpg' }}" alt="Profile Preview" 
                                             class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                                    </div>
                                    <small class="form-text text-muted">Upload a square image (PNG, JPG, JPEG, GIF, WEBP) for best results</small>
                                </form>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Promotional Banner</h6>
                            <div class="mb-3">
                                {% if clinic.promotional_banner_url %}
                                <div class="current-image mb-2">
                                    <img src="{{ clinic.promotional_banner_url }}" alt="Current Banner" class="img-thumbnail" style="max-width: 200px; height: auto;">
                                </div>
                                {% endif %}
                                <form id="bannerImageForm" enctype="multipart/form-data" onsubmit="uploadBannerImage(event)">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <div class="input-group">
                                        <input type="file" class="form-control" name="banner_image" accept="image/*" required>
                                        <button type="submit" class="btn btn-primary">Upload</button>
                                    </div>
                                    <small class="form-text text-muted">Upload a wide banner image (1200x300px recommended)</small>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clinic Highlights -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Clinic Highlights</h5>
                </div>
                <div class="card-body">
                    <form id="highlightsForm" onsubmit="updateHighlights(event)">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label class="form-label">Key Highlights (one per line)</label>
                            <textarea class="form-control" name="highlights" rows="5" placeholder="e.g., 10+ Years Experience&#10;ISO Certified Facility&#10;Award-Winning Surgeons&#10;State-of-the-art Equipment">{{ clinic.highlights or '' }}</textarea>
                            <small class="form-text text-muted">Enter each highlight on a new line. These will appear as bullet points on your profile.</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Highlights</button>
                    </form>
                </div>
            </div>

            <!-- Clinic Specialties -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Clinic Specialties</h5>
                </div>
                <div class="card-body">
                    <form id="specialtiesForm" onsubmit="updateSpecialties(event)">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label class="form-label">Select Your Specialties</label>
                            <div class="row">
                                {% for category in categories[:12] %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="specialties" value="{{ category.id }}" 
                                               id="specialty_{{ category.id }}"
                                               {% if clinic.specialties and category.id|string in clinic.specialties.split(',') %}checked{% endif %}>
                                        <label class="form-check-label" for="specialty_{{ category.id }}">
                                            {{ category.name }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Specialties</button>
                    </form>
                </div>
            </div>

            <!-- Popular Procedures -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Popular Procedures</h5>
                </div>
                <div class="card-body">
                    <form id="popularProceduresForm" onsubmit="updatePopularProcedures(event)">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label class="form-label">Select Your Most Popular Procedures</label>
                            <div class="row">
                                {% for procedure in procedures[:15] %}
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="popular_procedures" value="{{ procedure.id }}" 
                                               id="procedure_{{ procedure.id }}"
                                               {% if clinic.popular_procedures and procedure.id|string in clinic.popular_procedures.split(',') %}checked{% endif %}>
                                        <label class="form-check-label" for="procedure_{{ procedure.id }}">
                                            {{ procedure.procedure_name }}
                                            <small class="text-muted">(₹{{ procedure.min_cost|int }} - ₹{{ procedure.max_cost|int }})</small>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Popular Procedures</button>
                    </form>
                </div>
            </div>

            <!-- Contact Settings -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Contact Settings</h5>
                </div>
                <div class="card-body">
                    <form id="contactForm" onsubmit="updateContactSettings(event)">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Primary Contact Number</label>
                                    <input type="tel" class="form-control" name="contact_number" value="{{ clinic.contact_number or '' }}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">WhatsApp Number</label>
                                    <input type="tel" class="form-control" name="whatsapp_number" value="{{ clinic.whatsapp_number or '' }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-control" name="email" value="{{ clinic.email or '' }}" required>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Contact Settings</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Package Management Tab -->
        <div class="tab-pane fade" id="packages">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Treatment Packages</h5>
                            <a href="/clinic/packages/add" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus me-1"></i>Add Package
                            </a>
                        </div>
                        <div class="card-body">
                            {% if packages %}
                            <div class="row">
                                {% for package in packages %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border">
                                        <div class="card-body">
                                            <h6 class="card-title">{{ package.title or 'Treatment Package' }}
                                                {% if package.actual_treatment_name %}
                                                    <span class="text-muted" style="font-weight: 400; font-size: 0.9em;">
                                                        ({{ package.actual_treatment_name }})
                                                    </span>
                                                {% endif %}
                                            </h6>
                                            <p class="text-muted small">{{ package.procedure_name }}</p>
                                            <p class="card-text">{{ (package.description or '')[:100] }}{% if (package.description or '')|length > 100 %}...{% endif %}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    {% if package.price_discounted and package.price_discounted < package.price_actual %}
                                                        <span class="text-muted text-decoration-line-through">₹{{ package.price_actual|int }}</span>
                                                        <span class="text-success fw-bold">₹{{ package.price_discounted|int }}</span>
                                                    {% else %}
                                                        <span class="text-primary fw-bold">₹{{ package.price_actual|int }}</span>
                                                    {% endif %}
                                                </div>
                                                <a href="/clinic/packages/edit/{{ package.id }}" class="btn btn-sm btn-outline-primary">Edit</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-box fa-3x text-muted mb-3"></i>
                                <h5>No packages yet</h5>
                                <p class="text-muted">Add treatment packages to showcase your services</p>
                                <a href="/clinic/packages/add" class="btn btn-primary">Add Your First Package</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card" id="addPackageCard" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0">Add New Package</h6>
                        </div>
                        <div class="card-body">
                            <form id="packageForm" onsubmit="addPackage(event)">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="mb-3">
                                    <label class="form-label">Package Name</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Procedure Name</label>
                                    <input type="text" class="form-control" name="procedure_name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" name="description" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Base Price (₹)</label>
                                    <input type="number" class="form-control" name="base_price" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Discounted Price (₹)</label>
                                    <input type="number" class="form-control" name="discounted_price">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Duration</label>
                                    <input type="text" class="form-control" name="duration" placeholder="e.g., 2-3 hours">
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">Add Package</button>
                                    <button type="button" class="btn btn-secondary" onclick="hideAddPackageForm()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Doctor Management Tab -->
        <div class="tab-pane fade" id="doctors">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Clinic Doctors</h5>
                            <button class="btn btn-primary btn-sm" onclick="showAddDoctorForm()">
                                <i class="fas fa-plus me-1"></i>Add Doctor
                            </button>
                        </div>
                        <div class="card-body">
                            {% if doctors %}
                            <div class="row">
                                {% for doctor in doctors %}
                                <div class="col-md-6 mb-3">
                                    <div class="card border">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="me-3">
                                                    {% if doctor.profile_image %}
                                                        <img src="{{ doctor.profile_image }}" alt="Dr. {{ doctor.name }}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                                    {% else %}
                                                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                            <i class="fas fa-user-md text-muted"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">Dr. {{ doctor.name }}</h6>
                                                    {% if doctor.qualification %}
                                                        <small class="text-muted">{{ doctor.qualification }}</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if doctor.specialization %}
                                                <p class="small mb-1"><strong>Specialization:</strong> {{ doctor.specialization }}</p>
                                            {% endif %}
                                            {% if doctor.experience_years %}
                                                <p class="small mb-1"><strong>Experience:</strong> {{ doctor.experience_years }} years</p>
                                            {% endif %}
                                            {% if doctor.is_primary %}
                                                <span class="badge bg-primary">Primary Doctor</span>
                                            {% endif %}
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-primary me-2" onclick="editDoctor({{ doctor.id }})">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="removeDoctor({{ doctor.id }})">
                                                    <i class="fas fa-trash"></i> Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-user-md fa-3x text-muted mb-3"></i>
                                <h5>No doctors added yet</h5>
                                <p class="text-muted">Add doctors to showcase your medical team</p>
                                <button class="btn btn-primary" onclick="showAddDoctorForm()">Add Your First Doctor</button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card" id="addDoctorCard" style="display: none;">
                        <div class="card-header">
                            <h6 class="mb-0">Add Doctor to Clinic</h6>
                            <div class="btn-group btn-group-sm mt-2" role="group">
                                <button type="button" class="btn btn-outline-primary active" onclick="switchDoctorMode('search')">Search Existing</button>
                                <button type="button" class="btn btn-outline-primary" onclick="switchDoctorMode('new')">Create New</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Search Existing Doctor Mode -->
                            <div id="searchDoctorMode" class="doctor-mode">
                                <div class="mb-3">
                                    <label class="form-label">Search Doctor</label>
                                    <input type="text" class="form-control" id="doctorSearchInput" placeholder="Search by name, phone, or specialization..." onkeyup="searchDoctors(this.value)">
                                </div>
                                <div id="doctorSearchResults" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                                    <!-- Search results will be populated here -->
                                </div>
                                <div id="selectedDoctorInfo" style="display: none;">
                                    <div class="alert alert-info">
                                        <strong>Selected Doctor:</strong>
                                        <div id="selectedDoctorDetails"></div>
                                        <button type="button" class="btn btn-success btn-sm mt-2" onclick="addExistingDoctor()">Add to Clinic</button>
                                        <button type="button" class="btn btn-secondary btn-sm mt-2 ms-2" onclick="clearDoctorSelection()">Clear Selection</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Create New Doctor Mode -->
                            <div id="newDoctorMode" class="doctor-mode" style="display: none;">
                            <form id="doctorForm" onsubmit="addDoctor(event)">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <!-- Basic Information -->
                                <div class="mb-3">
                                    <label class="form-label">Doctor Name *</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                                
                                <!-- Contact Information -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Phone Number *</label>
                                            <input type="tel" class="form-control" name="phone_number" placeholder="+91-9876543210" pattern="^[+]?[0-9\s\-\(\)]{10,20}$" required>
                                            <small class="text-muted">Format: +91-9876543210 (10-20 characters with country code)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Email Address</label>
                                            <input type="email" class="form-control" name="email" placeholder="doctor@example.com">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Qualification *</label>
                                            <input type="text" class="form-control" name="qualification" placeholder="e.g., MBBS, MD, MS" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Specialization *</label>
                                            <input type="text" class="form-control" name="specialty" placeholder="e.g., Plastic Surgery" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Location Information (Auto-populated from clinic) -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">City *</label>
                                            <input type="text" class="form-control" name="city" value="{{ clinic.city or '' }}" readonly>
                                            <small class="text-muted">Auto-filled from clinic location</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">State</label>
                                            <input type="text" class="form-control" name="state" value="{{ clinic.state or '' }}" readonly>
                                            <small class="text-muted">Auto-filled from clinic location</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Experience (Years) *</label>
                                            <input type="number" class="form-control" name="experience" min="0" max="50" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Consultation Fee (₹)</label>
                                            <input type="number" class="form-control" name="consultation_fee" min="0" placeholder="1500">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Professional Details -->
                                <div class="mb-3">
                                    <label class="form-label">Medical License Number</label>
                                    <input type="text" class="form-control" name="medical_license_number" placeholder="e.g., MCI-12345-2024">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Practice Location</label>
                                    <input type="text" class="form-control" name="practice_location" value="{{ clinic.address or '' }}" readonly>
                                    <small class="text-muted">Auto-filled from clinic address</small>
                                </div>
                                
                                <!-- Profile Picture Upload -->
                                <div class="mb-3">
                                    <label class="form-label">Profile Picture</label>
                                    <div class="row">
                                        <div class="col-md-8">
                                            <input type="file" class="form-control" name="profile_image" accept="image/*" onchange="previewProfileImage(this)">
                                            <small class="text-muted">Upload doctor's profile picture (JPG, PNG, max 5MB)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <img id="profilePreview" src="/static/images/default-doctor.jpg" alt="Profile Preview" 
                                                     class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">Or provide image URL:</small>
                                        <input type="url" class="form-control form-control-sm mt-1" name="profile_image_url" 
                                               placeholder="https://example.com/doctor-photo.jpg" onchange="previewProfileImageFromURL(this)">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Biography</label>
                                    <textarea class="form-control" name="bio" rows="3" placeholder="Professional background and expertise..."></textarea>
                                </div>
                                
                                <!-- Education (JSON format) -->
                                <div class="mb-3">
                                    <label class="form-label">Education Background</label>
                                    <div id="educationContainer">
                                        <div class="education-entry mb-2">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <input type="text" class="form-control" name="education_degree[]" placeholder="Degree (e.g., MBBS)">
                                                </div>
                                                <div class="col-md-5">
                                                    <input type="text" class="form-control" name="education_institution[]" placeholder="Institution">
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control" name="education_year[]" placeholder="Year" min="1990" max="2030">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addEducationEntry()">+ Add Education</button>
                                </div>
                                
                                <!-- Certifications -->
                                <div class="mb-3">
                                    <label class="form-label">Certifications</label>
                                    <div id="certificationContainer">
                                        <div class="certification-entry mb-2">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" name="certification_name[]" placeholder="Certification name">
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="text" class="form-control" name="certification_organization[]" placeholder="Organization">
                                                </div>
                                                <div class="col-md-2">
                                                    <input type="number" class="form-control" name="certification_year[]" placeholder="Year" min="1990" max="2030">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCertificationEntry()">+ Add Certification</button>
                                </div>
                                
                                <!-- Role and Settings -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Role in Clinic</label>
                                            <select class="form-control" name="role">
                                                <option value="doctor">Doctor</option>
                                                <option value="consultant">Consultant</option>
                                                <option value="specialist">Specialist</option>
                                                <option value="senior_consultant">Senior Consultant</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="is_primary" id="isPrimary">
                                                <label class="form-check-label" for="isPrimary">
                                                    Primary Doctor for Clinic
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Verification Note -->
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Verification Required:</strong> All doctors require admin verification before appearing in search results. You'll be notified once verification is complete.
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">Add Doctor</button>
                                    <button type="button" class="btn btn-secondary" onclick="hideAddDoctorForm()">Cancel</button>
                                </div>
                            </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clinic Highlights Tab -->
        <div class="tab-pane fade" id="highlights">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Clinic Highlights</h5>
                </div>
                <div class="card-body">
                    <div id="highlightsContainer">
                        <!-- Highlights will be loaded here -->
                    </div>
                    <button class="btn btn-outline-primary btn-sm" onclick="addHighlight()">
                        <i class="fas fa-plus me-1"></i>Add Highlight
                    </button>
                    <button class="btn btn-primary ms-2" onclick="saveHighlights()">Save Highlights</button>
                </div>
            </div>
        </div>

        <!-- Specialties Tab -->
        <div class="tab-pane fade" id="specialties">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Clinic Specialties</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for category in categories %}
                        <div class="col-md-4 col-sm-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input specialty-checkbox" type="checkbox" value="{{ category.id }}" id="specialty{{ category.id }}">
                                <label class="form-check-label" for="specialty{{ category.id }}">
                                    {{ category.name }}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="btn btn-primary mt-3" onclick="saveSpecialties()">Save Specialties</button>
                </div>
            </div>
        </div>

        <!-- Popular Procedures Tab -->
        <div class="tab-pane fade" id="popular-procedures">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Popular Procedures</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for procedure in procedures %}
                        <div class="col-md-4 col-sm-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input procedure-checkbox" type="checkbox" value="{{ procedure.id }}" id="procedure{{ procedure.id }}">
                                <label class="form-check-label" for="procedure{{ procedure.id }}">
                                    {{ procedure.procedure_name }}
                                    <small class="text-muted d-block">₹{{ procedure.min_cost|int }} - ₹{{ procedure.max_cost|int }}</small>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="btn btn-primary mt-3" onclick="savePopularProcedures()">Save Popular Procedures</button>
                </div>
            </div>
        </div>

        <!-- Google Reviews Tab -->
        <div class="tab-pane fade" id="reviews">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Google Reviews Management</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>Connect Your Google Business Profile</h6>
                            <p class="text-muted">Link your Google Business URL to automatically sync authentic reviews and ratings.</p>
                            
                            <form id="googleBusinessForm" onsubmit="updateGoogleBusiness(event)">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="mb-3">
                                    <label class="form-label">Google Business URL</label>
                                    <input type="url" class="form-control" name="google_business_url" 
                                           value="{{ clinic.google_business_url or '' }}"
                                           placeholder="https://g.co/kgs/3mX75vm or https://maps.google.com/...">
                                    <small class="form-text text-muted">
                                        Copy your Google Business URL from Google Maps or Google My Business dashboard
                                    </small>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Current Google Rating</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" readonly 
                                                       value="{{ '%.1f'|format(clinic.google_rating) if clinic.google_rating else 'Not synced' }}">
                                                <span class="input-group-text">⭐</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Total Reviews</label>
                                            <input type="text" class="form-control" readonly 
                                                   value="{{ clinic.google_review_count or 0 }} reviews">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>Save Google Business URL
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="syncGoogleReviews()">
                                        <i class="fas fa-sync me-1"></i>Sync Reviews Now
                                    </button>
                                </div>
                            </form>
                            
                            {% if clinic.last_review_sync %}
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    Last synced: {{ clinic.last_review_sync.strftime('%B %d, %Y at %I:%M %p') }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">How to Find Your Google Business URL</h6>
                                    <ol class="small">
                                        <li>Go to <a href="https://www.google.com/maps" target="_blank">Google Maps</a></li>
                                        <li>Search for your clinic name</li>
                                        <li>Click on your business listing</li>
                                        <li>Copy the URL from your browser</li>
                                        <li>Paste it in the field above</li>
                                    </ol>
                                    <p class="small text-muted mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Your reviews will sync automatically every week once connected.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reviews Display -->
                    <div class="mt-4">
                        <h6>Recent Google Reviews</h6>
                        <div id="googleReviewsContainer">
                            <!-- Reviews will be loaded here -->
                            <div class="text-center py-3">
                                <p class="text-muted">Connect your Google Business URL to display reviews</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Settings Tab -->
        <div class="tab-pane fade" id="contact">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Contact Settings</h5>
                </div>
                <div class="card-body">
                    <form id="ctaForm" onsubmit="updateCTA(event)">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phone Number for CTA</label>
                                    <input type="tel" class="form-control" name="cta_phone_number" value="{{ clinic.cta_phone_number or '' }}" placeholder="Phone number for Call Now button">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">WhatsApp Number for CTA</label>
                                    <input type="tel" class="form-control" name="cta_whatsapp_number" value="{{ clinic.cta_whatsapp_number or '' }}" placeholder="WhatsApp number for WhatsApp button">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Contact Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Profile Management Functions
function updateProfile(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    fetch('/clinic/update-profile', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error updating profile');
    });
}

// Image Upload Functions
function uploadProfileImage(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Uploading...';
    submitBtn.disabled = true;
    
    fetch('/clinic/upload/profile-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Update the displayed image if successful
            if (data.image_url) {
                const currentImageDiv = form.parentElement.querySelector('.current-image');
                if (currentImageDiv) {
                    currentImageDiv.innerHTML = `<img src="${data.image_url}" alt="Current Profile Image" class="img-thumbnail" style="max-width: 200px; height: auto;">`;
                } else {
                    // Create new image display
                    const newImageDiv = document.createElement('div');
                    newImageDiv.className = 'current-image mb-2';
                    newImageDiv.innerHTML = `<img src="${data.image_url}" alt="Current Profile Image" class="img-thumbnail" style="max-width: 200px; height: auto;">`;
                    form.parentElement.insertBefore(newImageDiv, form);
                }
            }
            form.reset();
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error uploading profile image');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

function uploadBannerImage(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Uploading...';
    submitBtn.disabled = true;
    
    fetch('/clinic/upload/banner-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Update the displayed image if successful
            if (data.image_url) {
                const currentImageDiv = form.parentElement.querySelector('.current-image');
                if (currentImageDiv) {
                    currentImageDiv.innerHTML = `<img src="${data.image_url}" alt="Current Banner" class="img-thumbnail" style="max-width: 200px; height: auto;">`;
                } else {
                    // Create new image display
                    const newImageDiv = document.createElement('div');
                    newImageDiv.className = 'current-image mb-2';
                    newImageDiv.innerHTML = `<img src="${data.image_url}" alt="Current Banner" class="img-thumbnail" style="max-width: 200px; height: auto;">`;
                    form.parentElement.insertBefore(newImageDiv, form);
                }
            }
            form.reset();
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error uploading banner image');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// Contact Settings Function
function updateContactSettings(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    fetch('/clinic/update-contact', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error updating contact settings');
    });
}

// Clinic Enhancement Functions
function updateHighlights(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    fetch('/clinic/update-highlights', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error updating highlights');
    });
}

function updateSpecialties(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    // Get selected specialties
    const selectedSpecialties = [];
    const checkboxes = form.querySelectorAll('input[name="specialties"]:checked');
    checkboxes.forEach(checkbox => {
        selectedSpecialties.push(checkbox.value);
    });
    
    formData.append('selected_specialties', selectedSpecialties.join(','));
    
    fetch('/clinic/update-specialties', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error updating specialties');
    });
}

function updatePopularProcedures(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    // Get selected procedures
    const selectedProcedures = [];
    const checkboxes = form.querySelectorAll('input[name="popular_procedures"]:checked');
    checkboxes.forEach(checkbox => {
        selectedProcedures.push(checkbox.value);
    });
    
    formData.append('selected_procedures', selectedProcedures.join(','));
    
    fetch('/clinic/update-popular-procedures', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error updating popular procedures');
    });
}

// Package Management Functions
function showAddPackageForm() {
    document.getElementById('addPackageCard').style.display = 'block';
}

function hideAddPackageForm() {
    document.getElementById('addPackageCard').style.display = 'none';
    document.getElementById('packageForm').reset();
}

function addPackage(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    formData.append('csrf_token', document.querySelector('meta[name=csrf-token]').getAttribute('content'));
    
    fetch('/clinic/packages/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            hideAddPackageForm();
            location.reload();
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error adding package');
    });
}

// Doctor Management Functions
function showAddDoctorForm() {
    document.getElementById('addDoctorCard').style.display = 'block';
}

function hideAddDoctorForm() {
    document.getElementById('addDoctorCard').style.display = 'none';
    document.getElementById('doctorForm').reset();
}

function addDoctor(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    formData.append('csrf_token', document.querySelector('meta[name=csrf-token]').getAttribute('content'));
    
    fetch('/clinic/doctors/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            hideAddDoctorForm();
            location.reload();
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error adding doctor');
    });
}

// Highlights Management
let highlights = {{ (clinic.clinic_highlights|tojson) if clinic.clinic_highlights else '[]'|safe }};

function loadHighlights() {
    const container = document.getElementById('highlightsContainer');
    container.innerHTML = '';
    
    highlights.forEach((highlight, index) => {
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
            <input type="text" class="form-control" value="${highlight}" onchange="updateHighlight(${index}, this.value)">
            <button class="btn btn-outline-danger" onclick="removeHighlight(${index})">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(div);
    });
}

function addHighlight() {
    highlights.push('');
    loadHighlights();
}

function updateHighlight(index, value) {
    highlights[index] = value;
}

function removeHighlight(index) {
    highlights.splice(index, 1);
    loadHighlights();
}

function saveHighlights() {
    // Filter out empty highlights
    const filteredHighlights = highlights.filter(h => h.trim() !== '');
    
    fetch('/clinic/highlights/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify({highlights: filteredHighlights})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error saving highlights');
    });
}

// Specialties Management
function saveSpecialties() {
    const checkboxes = document.querySelectorAll('.specialty-checkbox:checked');
    const specialtyIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    fetch('/clinic/specialties/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify({specialty_ids: specialtyIds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error saving specialties');
    });
}

// Popular Procedures Management
function savePopularProcedures() {
    const checkboxes = document.querySelectorAll('.procedure-checkbox:checked');
    const procedureIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    fetch('/clinic/popular-procedures/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        },
        body: JSON.stringify({procedure_ids: procedureIds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error saving popular procedures');
    });
}

// CTA Settings
function updateCTA(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    fetch('/clinic/cta/update', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error updating contact settings');
    });
}

// Utility Functions
function showAlert(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

function contactLead(contactInfo) {
    alert('Contact Info: ' + contactInfo);
}

// Profile Image Preview Functions
function previewProfileImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profilePreview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
        
        // Clear URL input if file is selected
        document.querySelector('input[name="profile_image_url"]').value = '';
    }
}

function previewProfileImageFromURL(input) {
    if (input.value.trim()) {
        const img = document.getElementById('profilePreview');
        img.src = input.value;
        
        // Clear file input if URL is provided
        document.querySelector('input[name="profile_image"]').value = '';
        
        // Handle image load error
        img.onerror = function() {
            this.src = '/static/images/default-doctor.jpg';
            showAlert('error', 'Unable to load image from URL');
        };
    }
}

// Clinic Image Preview Functions
function previewClinicImage(input, previewId) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById(previewId).src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
        
        // Clear URL input if file is selected
        const form = input.closest('form');
        const urlInput = form.querySelector('input[name="profile_image_url"]');
        if (urlInput) urlInput.value = '';
    }
}

function previewClinicImageFromURL(input, previewId) {
    if (input.value.trim()) {
        const img = document.getElementById(previewId);
        img.src = input.value;
        
        // Clear file input if URL is provided
        const form = input.closest('form');
        const fileInput = form.querySelector('input[name="profile_image"]');
        if (fileInput) fileInput.value = '';
        
        // Handle image load error
        img.onerror = function() {
            this.src = '/static/images/default-clinic.jpg';
            showAlert('error', 'Unable to load image from URL');
        };
    }
}

function uploadFromURL(type) {
    const form = document.getElementById(type === 'profile' ? 'profileImageForm' : 'bannerImageForm');
    const urlInput = form.querySelector('input[name="profile_image_url"]');
    
    if (!urlInput.value.trim()) {
        showAlert('error', 'Please enter an image URL first');
        return;
    }
    
    // Create FormData with URL
    const formData = new FormData();
    formData.append('profile_image_url', urlInput.value);
    
    // Submit the form
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Uploading...';
    submitBtn.disabled = true;
    
    fetch(form.action || '/clinic/upload/profile-image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Update the displayed image if successful
            if (data.image_url) {
                const currentImageDiv = form.parentElement.querySelector('.current-image');
                if (currentImageDiv) {
                    currentImageDiv.innerHTML = `<img src="${data.image_url}" alt="Current Image" class="img-thumbnail" style="max-width: 200px; height: auto;">`;
                } else {
                    // Create new image display
                    const newImageDiv = document.createElement('div');
                    newImageDiv.className = 'current-image mb-2';
                    newImageDiv.innerHTML = `<img src="${data.image_url}" alt="Current Image" class="img-thumbnail" style="max-width: 200px; height: auto;">`;
                    form.parentElement.insertBefore(newImageDiv, form);
                }
            }
            form.reset();
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error uploading image');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// Doctor Management Functions
function showAddDoctorForm() {
    document.getElementById('addDoctorCard').style.display = 'block';
}

function hideAddDoctorForm() {
    document.getElementById('addDoctorCard').style.display = 'none';
    document.getElementById('doctorForm').reset();
    // Reset dynamic containers
    resetEducationEntries();
    resetCertificationEntries();
}

function addEducationEntry() {
    const container = document.getElementById('educationContainer');
    const entryDiv = document.createElement('div');
    entryDiv.className = 'education-entry mb-2';
    entryDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <input type="text" class="form-control" name="education_degree[]" placeholder="Degree (e.g., MBBS)">
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" name="education_institution[]" placeholder="Institution">
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" name="education_year[]" placeholder="Year" min="1990" max="2030">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEducationEntry(this)">×</button>
            </div>
        </div>
    `;
    container.appendChild(entryDiv);
}

function removeEducationEntry(button) {
    button.closest('.education-entry').remove();
}

function resetEducationEntries() {
    const container = document.getElementById('educationContainer');
    if (container) {
        container.innerHTML = `
            <div class="education-entry mb-2">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="education_degree[]" placeholder="Degree (e.g., MBBS)">
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control" name="education_institution[]" placeholder="Institution">
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" name="education_year[]" placeholder="Year" min="1990" max="2030">
                    </div>
                </div>
            </div>
        `;
    }
}

function addCertificationEntry() {
    const container = document.getElementById('certificationContainer');
    const entryDiv = document.createElement('div');
    entryDiv.className = 'certification-entry mb-2';
    entryDiv.innerHTML = `
        <div class="row">
            <div class="col-md-5">
                <input type="text" class="form-control" name="certification_name[]" placeholder="Certification name">
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" name="certification_organization[]" placeholder="Organization">
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" name="certification_year[]" placeholder="Year" min="1990" max="2030">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCertificationEntry(this)">×</button>
            </div>
        </div>
    `;
    container.appendChild(entryDiv);
}

function removeCertificationEntry(button) {
    button.closest('.certification-entry').remove();
}

function resetCertificationEntries() {
    const container = document.getElementById('certificationContainer');
    if (container) {
        container.innerHTML = `
            <div class="certification-entry mb-2">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="certification_name[]" placeholder="Certification name">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="certification_organization[]" placeholder="Organization">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" name="certification_year[]" placeholder="Year" min="1990" max="2030">
                    </div>
                </div>
            </div>
        `;
    }
}

function addDoctor(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    // Add CSRF token
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (csrfToken) {
        formData.append('csrf_token', csrfToken.getAttribute('content'));
    }
    
    // Process education entries into JSON
    const educationDegrees = formData.getAll('education_degree[]');
    const educationInstitutions = formData.getAll('education_institution[]');
    const educationYears = formData.getAll('education_year[]');
    
    const education = [];
    for (let i = 0; i < educationDegrees.length; i++) {
        if (educationDegrees[i].trim()) {
            education.push({
                degree: educationDegrees[i].trim(),
                institution: educationInstitutions[i]?.trim() || '',
                year: educationYears[i] || ''
            });
        }
    }
    
    // Process certification entries into JSON
    const certificationNames = formData.getAll('certification_name[]');
    const certificationOrgs = formData.getAll('certification_organization[]');
    const certificationYears = formData.getAll('certification_year[]');
    
    const certifications = [];
    for (let i = 0; i < certificationNames.length; i++) {
        if (certificationNames[i].trim()) {
            certifications.push({
                name: certificationNames[i].trim(),
                organization: certificationOrgs[i]?.trim() || '',
                year: certificationYears[i] || ''
            });
        }
    }
    
    // Add JSON data to form
    formData.append('education_json', JSON.stringify(education));
    formData.append('certifications_json', JSON.stringify(certifications));
    
    fetch('/clinic/doctors/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            hideAddDoctorForm();
            location.reload();
        } else {
            showAlert('error', data.message || 'Failed to add doctor');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Error adding doctor');
    });
}

// Doctor Management Functions
let selectedDoctorId = null;

function showAddDoctorForm() {
    document.getElementById('addDoctorCard').style.display = 'block';
    switchDoctorMode('search'); // Default to search mode
}

function hideAddDoctorForm() {
    document.getElementById('addDoctorCard').style.display = 'none';
    clearDoctorSelection();
    const searchInput = document.getElementById('doctorSearchInput');
    if (searchInput) searchInput.value = '';
    const searchResults = document.getElementById('doctorSearchResults');
    if (searchResults) searchResults.innerHTML = '';
}

function switchDoctorMode(mode) {
    const searchMode = document.getElementById('searchDoctorMode');
    const newMode = document.getElementById('newDoctorMode');
    const buttons = document.querySelectorAll('#addDoctorCard .btn-group button');
    
    buttons.forEach(btn => btn.classList.remove('active'));
    
    if (mode === 'search') {
        searchMode.style.display = 'block';
        newMode.style.display = 'none';
        buttons[0].classList.add('active');
        // Load recent doctors on first open
        if (!document.getElementById('doctorSearchResults').innerHTML.trim()) {
            searchDoctors('');
        }
    } else {
        searchMode.style.display = 'none';
        newMode.style.display = 'block';
        buttons[1].classList.add('active');
    }
}

function searchDoctors(query) {
    fetch(`/clinic/doctors/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const resultsContainer = document.getElementById('doctorSearchResults');
            
            if (data.success && data.doctors.length > 0) {
                resultsContainer.innerHTML = data.doctors.map(doctor => `
                    <div class="doctor-result-item p-2 border rounded mb-2" style="cursor: pointer;" 
                         onclick="selectDoctor(${doctor.id}, '${doctor.name}', '${doctor.specialty}', '${doctor.qualification}', '${doctor.experience}', '${doctor.city}', '${doctor.phone_number || 'N/A'}')">
                        <div class="d-flex align-items-center">
                            <img src="${doctor.profile_image || '/static/images/default-doctor.jpg'}" 
                                 class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <div class="fw-bold">${doctor.name}</div>
                                <small class="text-muted">${doctor.qualification} - ${doctor.specialty}</small>
                                <br>
                                <small class="text-muted">${doctor.experience} years exp. • ${doctor.city}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-success">Available</small>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                resultsContainer.innerHTML = query 
                    ? '<div class="text-center text-muted p-3">No doctors found matching your search.</div>'
                    : '<div class="text-center text-muted p-3">Start typing to search for doctors...</div>';
            }
        })
        .catch(error => {
            console.error('Error searching doctors:', error);
            document.getElementById('doctorSearchResults').innerHTML = 
                '<div class="text-center text-danger p-3">Error searching doctors. Please try again.</div>';
        });
}

function selectDoctor(id, name, specialty, qualification, experience, city, phone) {
    selectedDoctorId = id;
    
    document.getElementById('selectedDoctorDetails').innerHTML = `
        <div class="mt-2">
            <strong>${name}</strong><br>
            <small>${qualification} - ${specialty}</small><br>
            <small>${experience} years experience • ${city}</small><br>
            <small>Phone: ${phone}</small>
        </div>
    `;
    
    document.getElementById('selectedDoctorInfo').style.display = 'block';
    
    // Highlight selected doctor
    document.querySelectorAll('.doctor-result-item').forEach(item => {
        item.classList.remove('border-primary', 'bg-light');
    });
    event.target.closest('.doctor-result-item').classList.add('border-primary', 'bg-light');
}

function clearDoctorSelection() {
    selectedDoctorId = null;
    const selectedInfo = document.getElementById('selectedDoctorInfo');
    if (selectedInfo) selectedInfo.style.display = 'none';
    document.querySelectorAll('.doctor-result-item').forEach(item => {
        item.classList.remove('border-primary', 'bg-light');
    });
}

function addExistingDoctor() {
    if (!selectedDoctorId) {
        showAlert('error', 'Please select a doctor first');
        return;
    }
    
    const formData = new FormData();
    formData.append('doctor_id', selectedDoctorId);
    formData.append('role', 'doctor');
    formData.append('csrf_token', '{{ csrf_token() }}');
    
    fetch('/clinic/doctors/add-existing', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            hideAddDoctorForm();
            location.reload();
        } else {
            showAlert('error', data.message || 'Failed to add doctor to clinic');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Error adding doctor to clinic');
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadHighlights();
    
    // Load current specialties
    const currentSpecialties = '{{ clinic.specialties or "" }}';
    if (currentSpecialties) {
        const specialtyIds = currentSpecialties.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
        specialtyIds.forEach(id => {
            const checkbox = document.getElementById('specialty' + id);
            if (checkbox) checkbox.checked = true;
        });
    }
    
    // Load current popular procedures
    const currentProcedures = {{ (clinic.popular_procedures|tojson) if clinic.popular_procedures else '[]'|safe }};
    if (currentProcedures && Array.isArray(currentProcedures)) {
        currentProcedures.forEach(id => {
            const checkbox = document.getElementById('procedure' + id);
            if (checkbox) checkbox.checked = true;
        });
    }
});

// Doctor Edit Functions
function editDoctor(doctorId) {
    // Fetch doctor details
    fetch(`/clinic/doctors/get/${doctorId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateEditForm(data.doctor);
                const modal = new bootstrap.Modal(document.getElementById('editDoctorModal'));
                modal.show();
            } else {
                showAlert('error', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error fetching doctor details');
        });
}

function populateEditForm(doctor) {
    document.getElementById('editDoctorId').value = doctor.id;
    document.getElementById('editDoctorName').value = doctor.name || '';
    document.getElementById('editDoctorQualification').value = doctor.qualification || '';
    document.getElementById('editDoctorSpecialty').value = doctor.specialty || '';
    document.getElementById('editDoctorCity').value = doctor.city || '';
    document.getElementById('editDoctorState').value = doctor.state || '';
    document.getElementById('editDoctorExperience').value = doctor.experience || '';
    document.getElementById('editDoctorConsultationFee').value = doctor.consultation_fee || '';
    document.getElementById('editDoctorLicense').value = doctor.medical_license_number || '';
    document.getElementById('editDoctorPracticeLocation').value = doctor.practice_location || '';
    document.getElementById('editDoctorImageUrl').value = doctor.profile_image || doctor.image_url || '';
    document.getElementById('editDoctorBio').value = doctor.bio || '';
    document.getElementById('editDoctorRole').value = doctor.role || 'doctor';
    document.getElementById('editDoctorIsPrimary').checked = doctor.is_primary || false;
    
    // Update profile preview if image exists
    if (doctor.profile_image || doctor.image_url) {
        document.getElementById('editProfilePreview').src = doctor.profile_image || doctor.image_url;
    }
    
    // Populate education and certifications if available
    populateEditEducation(doctor.education);
    populateEditCertifications(doctor.certifications);
}

function saveEditDoctor(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const doctorId = document.getElementById('editDoctorId').value;
    
    fetch(`/clinic/doctors/edit/${doctorId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            const modal = bootstrap.Modal.getInstance(document.getElementById('editDoctorModal'));
            modal.hide();
            location.reload();
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Error updating doctor');
    });
}

function removeDoctor(doctorId) {
    if (confirm('Are you sure you want to remove this doctor from your clinic?')) {
        fetch(`/clinic/doctors/remove/${doctorId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                location.reload();
            } else {
                showAlert('error', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error removing doctor');
        });
    }
}

// Helper functions for edit modal
function populateEditEducation(education) {
    const container = document.getElementById('editEducationContainer');
    container.innerHTML = '';
    
    if (education && Array.isArray(education) && education.length > 0) {
        education.forEach(edu => {
            addEditEducationEntry(edu.degree || '', edu.institution || '', edu.year || '');
        });
    } else {
        addEditEducationEntry();
    }
}

function populateEditCertifications(certifications) {
    const container = document.getElementById('editCertificationContainer');
    container.innerHTML = '';
    
    if (certifications && Array.isArray(certifications) && certifications.length > 0) {
        certifications.forEach(cert => {
            addEditCertificationEntry(cert.name || '', cert.organization || '', cert.year || '');
        });
    } else {
        addEditCertificationEntry();
    }
}

function addEditEducationEntry(degree = '', institution = '', year = '') {
    const container = document.getElementById('editEducationContainer');
    const entryDiv = document.createElement('div');
    entryDiv.className = 'education-entry mb-2';
    entryDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <input type="text" class="form-control" name="education_degree[]" placeholder="Degree (e.g., MBBS)" value="${degree}">
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" name="education_institution[]" placeholder="Institution" value="${institution}">
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" name="education_year[]" placeholder="Year" min="1990" max="2030" value="${year}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEditEducationEntry(this)">×</button>
            </div>
        </div>
    `;
    container.appendChild(entryDiv);
}

function addEditCertificationEntry(name = '', organization = '', year = '') {
    const container = document.getElementById('editCertificationContainer');
    const entryDiv = document.createElement('div');
    entryDiv.className = 'certification-entry mb-2';
    entryDiv.innerHTML = `
        <div class="row">
            <div class="col-md-5">
                <input type="text" class="form-control" name="certification_name[]" placeholder="Certification name" value="${name}">
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" name="certification_organization[]" placeholder="Organization" value="${organization}">
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" name="certification_year[]" placeholder="Year" min="1990" max="2030" value="${year}">
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEditCertificationEntry(this)">×</button>
            </div>
        </div>
    `;
    container.appendChild(entryDiv);
}

function removeEditEducationEntry(button) {
    button.closest('.education-entry').remove();
}

function removeEditCertificationEntry(button) {
    button.closest('.certification-entry').remove();
}

function previewEditProfileImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('editProfilePreview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function previewEditProfileImageFromURL(input) {
    const url = input.value.trim();
    if (url) {
        const img = document.getElementById('editProfilePreview');
        img.src = url;
        img.onerror = function() {
            this.src = '/static/images/default-doctor.jpg';
        };
    }
}
</script>

<!-- Edit Doctor Modal -->
<div class="modal fade" id="editDoctorModal" tabindex="-1" aria-labelledby="editDoctorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDoctorModalLabel">Edit Doctor Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="saveEditDoctor(event)" id="editDoctorForm">
                <div class="modal-body">
                    <input type="hidden" id="editDoctorId">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <!-- Basic Information -->
                    <div class="mb-3">
                        <label class="form-label">Doctor Name *</label>
                        <input type="text" class="form-control" id="editDoctorName" name="name" required>
                    </div>
                    
                    <!-- Professional Information -->
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Qualification *</label>
                                <input type="text" class="form-control" id="editDoctorQualification" name="qualification" placeholder="e.g., MBBS, MD, MS" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Specialization *</label>
                                <input type="text" class="form-control" id="editDoctorSpecialty" name="specialty" placeholder="e.g., Plastic Surgery" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">City *</label>
                                <input type="text" class="form-control" id="editDoctorCity" name="city" value="{{ clinic.city or '' }}" readonly>
                                <small class="text-muted">Auto-filled from clinic location</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">State</label>
                                <input type="text" class="form-control" id="editDoctorState" name="state" value="{{ clinic.state or '' }}" readonly>
                                <small class="text-muted">Auto-filled from clinic location</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Experience (Years) *</label>
                                <input type="number" class="form-control" id="editDoctorExperience" name="experience" min="0" max="50" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Consultation Fee (₹)</label>
                                <input type="number" class="form-control" id="editDoctorConsultationFee" name="consultation_fee" min="0" placeholder="1500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Professional Details -->
                    <div class="mb-3">
                        <label class="form-label">Medical License Number</label>
                        <input type="text" class="form-control" id="editDoctorLicense" name="medical_license_number" placeholder="e.g., MCI-12345-2024">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Practice Location</label>
                        <input type="text" class="form-control" id="editDoctorPracticeLocation" name="practice_location" value="{{ clinic.address or '' }}" readonly>
                        <small class="text-muted">Auto-filled from clinic address</small>
                    </div>
                    
                    <!-- Profile Picture Upload -->
                    <div class="mb-3">
                        <label class="form-label">Profile Picture</label>
                        <div class="row">
                            <div class="col-md-8">
                                <input type="file" class="form-control" name="profile_image" accept="image/*" onchange="previewEditProfileImage(this)">
                                <small class="text-muted">Upload doctor's profile picture (JPG, PNG, max 5MB)</small>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <img id="editProfilePreview" src="/static/images/default-doctor.jpg" alt="Profile Preview" 
                                         class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;">
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Or provide image URL:</small>
                            <input type="url" class="form-control form-control-sm mt-1" id="editDoctorImageUrl" name="profile_image_url" 
                                   placeholder="https://example.com/doctor-photo.jpg" onchange="previewEditProfileImageFromURL(this)">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Biography</label>
                        <textarea class="form-control" id="editDoctorBio" name="bio" rows="3" placeholder="Professional background and expertise..."></textarea>
                    </div>
                    
                    <!-- Education Background -->
                    <div class="mb-3">
                        <label class="form-label">Education Background</label>
                        <div id="editEducationContainer">
                            <div class="education-entry mb-2">
                                <div class="row">
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" name="education_degree[]" placeholder="Degree (e.g., MBBS)">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" name="education_institution[]" placeholder="Institution">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control" name="education_year[]" placeholder="Year" min="1990" max="2030">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addEditEducationEntry()">+ Add Education</button>
                    </div>
                    
                    <!-- Certifications -->
                    <div class="mb-3">
                        <label class="form-label">Certifications</label>
                        <div id="editCertificationContainer">
                            <div class="certification-entry mb-2">
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" name="certification_name[]" placeholder="Certification name">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" name="certification_organization[]" placeholder="Organization">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" name="certification_year[]" placeholder="Year" min="1990" max="2030">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addEditCertificationEntry()">+ Add Certification</button>
                    </div>
                    
                    <!-- Role and Settings -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Role in Clinic</label>
                                <select class="form-control" id="editDoctorRole" name="role">
                                    <option value="doctor">Doctor</option>
                                    <option value="consultant">Consultant</option>
                                    <option value="specialist">Specialist</option>
                                    <option value="senior_consultant">Senior Consultant</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editDoctorIsPrimary" name="is_primary">
                                    <label class="form-check-label" for="editDoctorIsPrimary">
                                        Primary Doctor for Clinic
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Doctor</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Google Reviews Management Functions
function updateGoogleBusiness(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    fetch('/clinic/google-reviews/configure', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Update the display with new rating info if available
            if (data.place_info && data.place_info.rating) {
                const ratingInput = document.querySelector('input[readonly][value*="Not synced"], input[readonly][value*="⭐"]');
                if (ratingInput) {
                    ratingInput.value = data.place_info.rating.toFixed(1);
                }
            }
            if (data.place_info && data.place_info.review_count) {
                const reviewInput = document.querySelector('input[readonly][value*="reviews"]');
                if (reviewInput) {
                    reviewInput.value = data.place_info.review_count + ' reviews';
                }
            }
        } else {
            showAlert('error', data.error || 'Failed to update Google Business URL');
        }
    })
    .catch(error => {
        console.error('Error updating Google Business URL:', error);
        showAlert('error', 'Error updating Google Business URL');
    });
}

function syncGoogleReviews() {
    const syncBtn = document.querySelector('button[onclick="syncGoogleReviews()"]');
    const originalText = syncBtn.innerHTML;
    
    // Show loading state
    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
    syncBtn.disabled = true;
    
    // Get CSRF token from the form
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    const formData = new FormData();
    formData.append('csrf_token', csrfToken);
    
    fetch('/clinic/google-reviews/sync', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Reload reviews display
            loadGoogleReviews();
            // Update rating and count if available
            if (data.google_rating) {
                document.querySelector('input[readonly][value*="Not synced"], input[readonly][value*="⭐"]').value = data.google_rating.toFixed(1);
            }
            if (data.google_review_count !== undefined) {
                document.querySelector('input[readonly][value*="reviews"]').value = data.google_review_count + ' reviews';
            }
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', 'Error syncing Google Reviews');
    })
    .finally(() => {
        syncBtn.innerHTML = originalText;
        syncBtn.disabled = false;
    });
}

function loadGoogleReviews() {
    fetch('/clinic/google-reviews/list')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('googleReviewsContainer');
        if (data.success && data.reviews && data.reviews.length > 0) {
            container.innerHTML = data.reviews.map(review => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                ${review.profile_photo_url ? 
                                    `<img src="${review.profile_photo_url}" alt="${review.author_name}" class="rounded-circle me-2" style="width: 40px; height: 40px;">` : 
                                    '<div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="fas fa-user text-white"></i></div>'
                                }
                                <div>
                                    <h6 class="mb-0">${review.author_name}</h6>
                                    <div class="text-warning">
                                        ${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">${review.relative_time_description}</small>
                        </div>
                        ${review.text ? `<p class="mb-0">${review.text}</p>` : ''}
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="text-center py-3"><p class="text-muted">No reviews found. Connect your Google Business URL and sync to display reviews.</p></div>';
        }
    })
    .catch(error => {
        console.error('Error loading reviews:', error);
    });
}

// Load Google Reviews when the reviews tab is shown
document.addEventListener('DOMContentLoaded', function() {
    const reviewsTab = document.querySelector('a[href="#reviews"]');
    if (reviewsTab) {
        reviewsTab.addEventListener('shown.bs.tab', function() {
            loadGoogleReviews();
        });
    }
});
</script>

{% endblock %}