{% extends 'base.html' %}

{% block title %}AI Recommendations Results - Antidote{% endblock %}

{% block extra_head %}
<style>
    /* Remove "Available" badges from doctor cards */
    .ultra-badge-success, 
    [data-availability="red-badge"],
    .availability-badge,
    .card .badge-danger,
    .card span.text-danger,
    .card a[class*="badge"],
    [class*="badge"][data-badge="available"],
    span.badge.ultra-badge-success {
        display: none !important;
    }
    
    /* Mobile-specific treatment card improvements */
    @media (max-width: 767.98px) {
        .list-group-item {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
        
        /* Ensure consistent spacing and alignment */
        .list-group-item .row {
            margin-left: 0;
            margin-right: 0;
        }
        
        .list-group-item .col-6,
        .list-group-item .col-12 {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        /* Better button styling on mobile */
        .btn-sm {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }
        
        /* Improved badge positioning */
        .badge {
            font-size: 0.7rem;
            white-space: nowrap;
        }
        
        /* Cost text wrapping */
        .text-success.fw-bold {
            font-size: 0.875rem;
            line-height: 1.2;
        }
        
        /* Analysis summary cards mobile optimization */
        .col-md-3 {
            margin-bottom: 1rem;
        }
        
        .col-md-3:last-child {
            margin-bottom: 0;
        }
    }
    

</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #00A0B0 0%, #00B5C5 100%); color: white;">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                            <h2 class="mb-3">
                                <i class="fas fa-robot me-2"></i>
                                Your Personalized AI Recommendations
                            </h2>
                            <p class="mb-0 lead">Based on your concerns: "{{ user_input[:100] }}{% if user_input|length > 100 %}...{% endif %}"</p>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Recommended Treatment Packages -->
    {% if packages %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h3 class="mb-0">
                    <i class="fas fa-gift text-primary me-2"></i>
                    Recommended Treatment Packages
                </h3>
                <span class="badge bg-primary fs-6">{{ packages|length }} found</span>
            </div>

            <div class="d-flex flex-column gap-3">
                {% for package in packages %}
                <div class="card shadow-sm package-card" 
                     style="cursor: pointer;" 
                     onclick="window.location.href='{{ url_for('enhanced_package.package_detail', slug=package.slug) }}'">
                    <div class="card-body">
                        <!-- Top Section: Package Info and Pricing -->
                        <div class="row align-items-center">
                            <!-- Left Section: Icon and Content -->
                            <div class="col-md-8">
                                <div class="package-info">
                                    <div class="title-price-container">
                                        <h5 class="card-title mb-1">{{ package.title }}</h5>
                                        <!-- Mobile price display - shows inline with title -->
                                        <div class="mobile-price d-md-none">
                                            {% if package.price_discounted and package.price_actual and package.price_discounted|int < package.price_actual|int %}
                                            <div class="text-muted text-decoration-line-through small">₹{{ "{:,}".format(package.price_actual|int) }}</div>
                                            <div class="h4 text-primary fw-bold mb-1 price-display-mobile">₹{{ "{:,}".format(package.price_discounted|int) }}</div>
                                            {% set discount_pct = ((package.price_actual|int - package.price_discounted|int) / package.price_actual|int * 100)|round|int %}
                                            <span class="badge bg-success">{{ discount_pct }}% OFF</span>
                                            {% else %}
                                            <div class="h4 text-primary fw-bold price-display-mobile">₹{{ "{:,}".format(package.price_actual|int) }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <h6 class="text-primary mb-2">
                                        {% if package.clinic %}
                                            {{ package.clinic.name }}
                                        {% elif package.clinic_name %}
                                            {{ package.clinic_name }}
                                        {% else %}
                                            Professional Clinic
                                        {% endif %}
                                    </h6>
                                    <p class="card-text text-muted small">{{ package.description }}</p>
                                    
                                    <!-- Additional Info -->
                                    <div class="d-flex gap-3 mt-2">
                                        {% if package.duration %}
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>{{ package.duration }}
                                        </small>
                                        {% endif %}
                                        {% if package.downtime %}
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>{{ package.downtime }} recovery
                                        </small>
                                        {% endif %}
                                        {% if package.clinic and package.clinic.city %}
                                        <small class="text-muted">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ package.clinic.city }}{% if package.clinic.state %}, {{ package.clinic.state }}{% endif %}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Section: Pricing - Desktop only -->
                            <div class="col-md-4 text-end d-none d-md-block">
                                {% if package.price_discounted and package.price_actual and package.price_discounted|int < package.price_actual|int %}
                                <div class="text-muted text-decoration-line-through small">₹{{ "{:,}".format(package.price_actual|int) }}</div>
                                <div class="h4 text-primary fw-bold mb-1 price-display">₹{{ "{:,}".format(package.price_discounted|int) }}</div>
                                {% set discount_pct = ((package.price_actual|int - package.price_discounted|int) / package.price_actual|int * 100)|round|int %}
                                <span class="badge bg-success">{{ discount_pct }}% OFF</span>
                                {% else %}
                                <div class="h4 text-primary fw-bold price-display">₹{{ "{:,}".format(package.price_actual|int) }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recommended Procedures -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h3 class="mb-0">
                    <i class="fas fa-medical-kit text-primary me-2"></i>
                    Recommended Treatments
                </h3>
                <span class="badge bg-primary fs-6">{{ procedures|length }} found</span>
            </div>

            {% if procedures %}
                <div class="list-group list-group-flush">
                    {% for procedure in procedures %}
                    <div class="list-group-item border-0 border-bottom py-4">
                        <!-- Mobile-first responsive layout -->
                        <div class="row align-items-center">
                            <!-- Treatment name and details - full width on mobile -->
                            <div class="col-12 col-md-5 mb-3 mb-md-0">
                                <div>
                                    <h6 class="mb-1 fw-semibold text-primary">{{ procedure.name }}</h6>
                                    <p class="text-muted small mb-1">{{ procedure.body_part }}</p>
                                    {% if procedure.description %}
                                        <p class="text-secondary small mb-2" style="font-size: 0.85rem; line-height: 1.3;">
                                            {{ procedure.description[:120] }}{% if procedure.description|length > 120 %}...{% endif %}
                                        </p>
                                    {% else %}
                                        <p class="text-secondary small mb-2" style="font-size: 0.85rem; line-height: 1.3;">
                                            {% if 'botox' in procedure.name.lower() %}
                                                Injectable treatment that reduces wrinkles by relaxing facial muscles, providing a smoother appearance.
                                            {% elif 'juvederm' in procedure.name.lower() or 'filler' in procedure.name.lower() %}
                                                Dermal filler that adds volume to restore youthful facial contours and smooth out lines.
                                            {% elif 'rhinoplasty' in procedure.name.lower() or 'nose' in procedure.name.lower() %}
                                                Surgical procedure to reshape the nose for improved appearance and sometimes breathing.
                                            {% elif 'liposuction' in procedure.name.lower() %}
                                                Fat removal procedure that sculpts body contours by removing excess fat deposits.
                                            {% elif 'facelift' in procedure.name.lower() %}
                                                Surgical procedure to tighten facial skin and muscles for a more youthful appearance.
                                            {% elif 'laser' in procedure.name.lower() %}
                                                Advanced laser technology treatment for skin rejuvenation and targeted improvements.
                                            {% elif 'microneedling' in procedure.name.lower() %}
                                                Minimally invasive treatment that stimulates skin renewal for improved texture and tone.
                                            {% elif 'chemical peel' in procedure.name.lower() or 'peel' in procedure.name.lower() %}
                                                Skin resurfacing treatment that removes damaged layers to reveal smoother, healthier skin.
                                            {% elif 'hair transplant' in procedure.name.lower() or 'hair' in procedure.name.lower() %}
                                                Hair restoration procedure that transplants healthy hair follicles to balding areas.
                                            {% elif 'breast' in procedure.name.lower() %}
                                                Cosmetic breast procedure to enhance size, shape, or correct asymmetry for improved confidence.
                                            {% elif 'tummy tuck' in procedure.name.lower() or 'abdominoplasty' in procedure.name.lower() %}
                                                Surgical procedure to remove excess skin and fat from the abdomen for a flatter profile.
                                            {% elif 'blepharoplasty' in procedure.name.lower() or 'eyelid' in procedure.name.lower() %}
                                                Eyelid surgery to remove excess skin and fat for a more alert, youthful eye appearance.
                                            {% else %}
                                                Professional cosmetic treatment designed to enhance your natural beauty and boost confidence.
                                            {% endif %}
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Cost - responsive layout -->
                            <div class="col-6 col-md-3 mb-3 mb-md-0">
                                {% if procedure.min_cost and procedure.max_cost %}
                                <div class="text-start text-md-center">
                                    <h6 class="mb-1 text-muted small">Estimated Cost</h6>
                                    <span class="text-success fw-bold d-block">
                                        {{ procedure.min_cost }} - {{ procedure.max_cost }}
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Button section - aligned properly on mobile -->
                            <div class="col-6 col-md-4 text-end">
                                <div class="d-flex flex-column align-items-end gap-2">
                                    <a href="{{ url_for('web.procedure_detail', procedure_id=procedure.id) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-arrow-right me-1"></i>Learn More
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-light border-start border-primary border-3 py-2 px-3 mb-0">
                                    <small class="text-primary">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        {{ procedure.reason }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No specific treatments found</h5>
                    <p class="text-muted">Try describing your concerns in more detail</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Clinics Near You -->
    {% if clinics %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h3 class="mb-0">
                    <i class="fas fa-hospital text-primary me-2"></i>
                    Clinics Near You
                </h3>
                <span class="badge bg-primary fs-6">{{ clinics|length }} found</span>
            </div>

            {% if clinics %}
                <div class="row">
                    {% for clinic in clinics %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 shadow-sm border-0 hover-shadow">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0">{{ clinic.name }}</h5>
                                </div>
                                
                                {% if clinic.description %}
                                <p class="text-muted small mb-3">{{ clinic.description[:100] }}{% if clinic.description|length > 100 %}...{% endif %}</p>
                                {% endif %}
                                
                                <div class="clinic-details">
                                    {% if clinic.city or clinic.state %}
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                        <span class="small">{{ clinic.city }}{% if clinic.state %}, {{ clinic.state }}{% endif %}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if clinic.phone %}
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-phone text-success me-2"></i>
                                        <span class="small">{{ clinic.phone }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if clinic.specialties %}
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="fas fa-stethoscope text-primary me-2"></i>
                                        <span class="small">{{ clinic.specialties[:2]|join(', ') }}{% if clinic.specialties|length > 2 %} +{{ clinic.specialties|length - 2 }} more{% endif %}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Rating -->
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        {% if clinic.rating %}
                                        <div class="rating-stars me-2">
                                            {% set rating = clinic.rating %}
                                            {% for i in range(5) %}
                                                {% if i < rating %}
                                                    <i class="fas fa-star text-warning"></i>
                                                {% else %}
                                                    <i class="far fa-star text-muted"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <span class="small text-muted">{{ "%.1f"|format(clinic.rating) }}{% if clinic.review_count %} ({{ clinic.review_count }} reviews){% endif %}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <a href="{{ url_for('clinic.clinic_detail', slug=clinic.id) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>View Profile
                                    </a>
                                </div>
                                
                                <!-- Why Recommended -->
                                <div class="alert alert-light border-start border-primary border-3 py-2 px-3 mb-0 mt-3">
                                    <small class="text-primary">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        {{ clinic.reason }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No clinics found</h5>
                    <p class="text-muted">Try expanding your search area</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Recommended Doctors -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h3 class="mb-0">
                    <i class="fas fa-user-md text-primary me-2"></i>
                    Specialist Doctors
                </h3>
                <span class="badge bg-primary fs-6">{{ doctors|length }} found</span>
            </div>

            {% if doctors %}
                <div class="row">
                    {% for doctor in doctors %}
                    <div class="col-12 mb-4">
                        <div class="card shadow-sm border-0 hover-shadow">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        {% if doctor.profile_image %}
                                            <img src="{{ doctor.profile_image }}" class="rounded-circle img-fluid mx-auto border" style="width: 120px; height: 120px; object-fit: cover;" alt="Dr. {{ doctor.name }}">
                                        {% else %}
                                            <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center mx-auto" style="width: 120px; height: 120px;">
                                                <i class="fas fa-user-md text-primary" style="font-size: 2.5rem;"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-9">
                                        <div class="d-flex align-items-center mb-2">
                                            <h4 class="card-title mb-0">{{ doctor.name }}</h4>
                                            {% if doctor.is_verified %}
                                                <span class="badge bg-success ms-2">
                                                    <i class="fas fa-check-circle"></i> Verified
                                                </span>
                                            {% endif %}
                                        </div>
                                        
                                        <p class="text-muted mb-2">{{ doctor.specialty }}</p>
                                        <p class="mb-1"><strong>Qualifications:</strong> {{ doctor.qualification|default('Board Certified Specialist') }}</p>
                                        
                                        <div class="row mt-3 mb-3">
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                    <span>{{ doctor.city or city or 'Location' }}</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-briefcase text-primary me-2"></i>
                                                    <span>{{ doctor.experience|default(10) }} yrs experience</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-calendar-check text-info me-2"></i>
                                                    <span>Available Today</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-award text-success me-2"></i>
                                                    <span>Top Specialist</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Why Recommended -->
                                        <div class="alert alert-light border-start border-success border-3 py-2 px-3 mb-3">
                                            <small class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                {{ doctor.reason }}
                                            </small>
                                        </div>
                                        
                                        <div class="d-flex gap-2 mt-3">
                                            <a href="{{ url_for('web.doctor_detail', doctor_id=doctor.id) }}" class="btn btn-primary">
                                                View Profile
                                            </a>
                                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bookConsultationModal{{ doctor.id }}">
                                                Book Consultation
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-user-md fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No specific doctors found</h5>
                    <p class="text-muted">Browse our complete directory of specialists</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body text-center">
                    <h5 class="mb-3">What's Next?</h5>
                    <div class="d-flex gap-3 justify-content-center flex-wrap">
                        <a href="{{ url_for('web.index') }}" class="btn btn-outline-primary">
                            <i class="fas fa-search me-1"></i>
                            New Search
                        </a>
                        {% if current_user.is_authenticated %}
                        <a href="{{ url_for('web.index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-history me-1"></i>
                            My History
                        </a>
                        {% endif %}
                        <a href="{{ url_for('web.procedures') }}" class="btn btn-outline-info">
                            <i class="fas fa-th-large me-1"></i>
                            Browse All Treatments
                        </a>
                        <a href="{{ url_for('web.doctors') }}" class="btn btn-outline-success">
                            <i class="fas fa-users me-1"></i>
                            Browse Doctors
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.hover-shadow {
    transition: all 0.3s ease;
}

.hover-shadow:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
}

.confidence-circle {
    text-align: center;
    padding: 15px;
}

.confidence-number {
    font-size: 1.5rem;
    font-weight: bold;
    display: block;
}

.doctor-avatar .avatar-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
}

.star-rating .fas,
.star-rating .far {
    font-size: 0.9rem;
}

.border-start {
    border-left-width: 3px !important;
}
</style>
{% endblock %}