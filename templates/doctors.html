{% extends 'base.html' %}

{% block title %}{{ title }} - Antidote{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/clinic-filters.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-search-ultra-compact.css') }}">
<style>
    .doctor-card .card {
        transition: all 0.3s ease;
        border-radius: 8px;
        background: #ffffff;
        border: 1px solid #e9ecef;
        cursor: pointer;
    }
    .doctor-card .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        border-color: #00A0B0;
    }
    .doctor-card a {
        color: inherit;
    }
    .doctor-card a:hover {
        color: inherit;
    }
    .doctor-card img, .doctor-card .rounded-circle {
        border: 2px solid #f8f9fa;
        transition: all 0.3s ease;
    }
    .doctor-card:hover img, .doctor-card:hover .rounded-circle {
        border-color: #00A0B0;
    }

    .doctor-card h5 {
        color: #2c3e50;
        font-weight: 600;
    }
    .doctor-card .text-muted {
        color: #6c757d !important;
    }
    @media (max-width: 768px) {
        .doctor-card .card-body {
            padding: 1rem;
        }
    }
    @media (max-width: 576px) {
        .doctor-card .row {
            --bs-gutter-x: 0.5rem;
        }
        .doctor-card img, .doctor-card .rounded-circle {
            width: 60px !important;
            height: 60px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">


    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    <!-- Enhanced Search Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="GET" id="doctorFilterForm">
                        <!-- Basic Filters Row -->
                        <div class="row g-3 mb-3">
                            <!-- Search Input -->
                            <div class="col-md-4">
                                <div class="position-relative">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" name="search" class="form-control" 
                                               placeholder="Search doctors, specialties..." 
                                               value="{{ request.args.get('search', request.args.get('q', '')) }}" id="doctorSearchInput">
                                    </div>
                                    <div id="doctorSearchSuggestions" class="dropdown-suggestions" style="display: none;"></div>
                                </div>
                            </div>

                            <!-- Location Filter -->
                            <div class="col-md-4">
                                <div class="position-relative">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                        <input type="text" name="location" class="form-control" placeholder="Select location..." 
                                               value="{{ request.args.get('location', '') }}" 
                                               id="doctorLocationInput" autocomplete="off">
                                        <button type="button" class="btn btn-outline-secondary" id="doctorUseLocationBtn">
                                            <i class="fas fa-location-arrow"></i>
                                        </button>
                                    </div>
                                    <div id="doctorLocationDropdown" class="dropdown-suggestions" style="display: none;"></div>
                                </div>
                            </div>

                            <!-- Search Button -->
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" type="submit">
                                    <i class="fas fa-search me-2"></i>Search Doctors
                                </button>
                            </div>
                        </div>

                        <!-- Advanced Filters Toggle -->
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-link p-0 text-decoration-none" id="doctorAdvancedFiltersToggle">
                                    <i class="fas fa-chevron-down me-1"></i>
                                    <span>Advanced Filters</span>
                                </button>
                            </div>
                        </div>

                        <!-- Advanced Filters Section (Hidden by default) -->
                        <div id="doctorAdvancedFiltersSection" style="display: none;" class="mt-3">
                            <div class="row g-3">
                                <!-- Specialty Filter -->
                                <div class="col-md-6 col-lg-3">
                                    <label class="form-label mb-1">Specialty</label>
                                    <div class="position-relative">
                                        <input type="text" name="specialty" class="form-control" placeholder="Select specialty..." 
                                               value="{{ request.args.get('specialty', '') }}" 
                                               id="doctorSpecialtyInput" autocomplete="off">
                                        <div class="dropdown-arrow"><i class="fas fa-chevron-down"></i></div>
                                        <div id="doctorSpecialtyDropdown" class="dropdown-suggestions" style="display: none;"></div>
                                    </div>
                                </div>

                                <!-- Rating Filter -->
                                <div class="col-md-6 col-lg-3">
                                    <label class="form-label mb-1">Minimum Rating</label>
                                    <select name="rating" class="form-select">
                                        <option value="">All Ratings</option>
                                        <option value="4.5" {% if request.args.get('rating') == '4.5' %}selected{% endif %}>4.5+ Stars</option>
                                        <option value="4.0" {% if request.args.get('rating') == '4.0' %}selected{% endif %}>4.0+ Stars</option>
                                        <option value="3.5" {% if request.args.get('rating') == '3.5' %}selected{% endif %}>3.5+ Stars</option>
                                        <option value="3.0" {% if request.args.get('rating') == '3.0' %}selected{% endif %}>3.0+ Stars</option>
                                    </select>
                                </div>

                                <!-- Experience Filter -->
                                <div class="col-md-6 col-lg-3">
                                    <label class="form-label mb-1">Experience</label>
                                    <select name="experience" class="form-select">
                                        <option value="">All Experience</option>
                                        <option value="10+" {% if request.args.get('experience') == '10+' %}selected{% endif %}>10+ Years</option>
                                        <option value="5-10" {% if request.args.get('experience') == '5-10' %}selected{% endif %}>5-10 Years</option>
                                        <option value="2-5" {% if request.args.get('experience') == '2-5' %}selected{% endif %}>2-5 Years</option>
                                        <option value="0-2" {% if request.args.get('experience') == '0-2' %}selected{% endif %}>0-2 Years</option>
                                    </select>
                                </div>

                                <!-- Sort Filter -->
                                <div class="col-md-6 col-lg-3">
                                    <label class="form-label mb-1">Sort by</label>
                                    <select name="sort" class="form-select">
                                        <option value="rating" {% if request.args.get('sort') == 'rating' %}selected{% endif %}>Highest Rated</option>
                                        <option value="experience" {% if request.args.get('sort') == 'experience' %}selected{% endif %}>Most Experienced</option>
                                        <option value="name" {% if request.args.get('sort') == 'name' %}selected{% endif %}>Name A-Z</option>
                                        <option value="newest" {% if request.args.get('sort') == 'newest' %}selected{% endif %}>Newest First</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Filter Sidebar -->
        <div class="col-md-3 mb-4">
            <div class="collapse d-lg-show" id="doctorFilterCollapse">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Filter Doctors</h5>
                        <button class="btn btn-sm btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#doctorFilterCollapse" aria-expanded="true" aria-controls="doctorFilterCollapse">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Location Filter -->
                        <div class="mb-4">
                            <h6 class="mb-2 filter-section-title">
                                <i class="fas fa-map-marker-alt me-2"></i> Location
                                <span class="float-end">
                                    <button class="btn btn-sm btn-link p-0 text-decoration-none toggle-section" data-target="locationFilterSection">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </span>
                            </h6>
                            <div id="locationFilterSection">
                                {% set unique_cities = [] %}
                                {% for doctor in doctors %}
                                    {% if doctor.city and doctor.city not in unique_cities %}
                                        {% set _ = unique_cities.append(doctor.city) %}
                                    {% endif %}
                                {% endfor %}
                                
                                <div class="filter-options-container" style="max-height: 150px; overflow-y: auto;">
                                    {% for city in unique_cities|sort %}
                                    <div class="form-check">
                                        <input class="form-check-input filter-location" type="checkbox" value="{{ city }}" id="city{{ loop.index }}">
                                        <label class="form-check-label" for="city{{ loop.index }}">{{ city }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Specialty Filter -->
                        <div class="mb-4">
                            <h6 class="mb-2 filter-section-title">
                                <i class="fas fa-stethoscope me-2"></i> Specialty
                                <span class="float-end">
                                    <button class="btn btn-sm btn-link p-0 text-decoration-none toggle-section" data-target="specialtyFilterSection">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </span>
                            </h6>
                            <div id="specialtyFilterSection">
                                {% set unique_specialties = [] %}
                                {% for doctor in doctors %}
                                    {% if doctor.specialty and doctor.specialty not in unique_specialties %}
                                        {% set _ = unique_specialties.append(doctor.specialty) %}
                                    {% endif %}
                                {% endfor %}
                                
                                <div class="filter-options-container" style="max-height: 150px; overflow-y: auto;">
                                    {% for specialty in unique_specialties|sort %}
                                    <div class="form-check">
                                        <input class="form-check-input filter-specialty" type="checkbox" value="{{ specialty }}" id="spec{{ loop.index }}">
                                        <label class="form-check-label" for="spec{{ loop.index }}">{{ specialty }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Experience Filter -->
                        <div class="mb-4">
                            <h6 class="mb-2 filter-section-title">
                                <i class="fas fa-briefcase me-2"></i> Experience
                                <span class="float-end">
                                    <button class="btn btn-sm btn-link p-0 text-decoration-none toggle-section" data-target="experienceFilterSection">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </span>
                            </h6>
                            <div id="experienceFilterSection">
                                <div class="form-check">
                                    <input class="form-check-input filter-experience" type="checkbox" value="5" id="exp5">
                                    <label class="form-check-label" for="exp5">5+ Years</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input filter-experience" type="checkbox" value="10" id="exp10">
                                    <label class="form-check-label" for="exp10">10+ Years</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input filter-experience" type="checkbox" value="15" id="exp15">
                                    <label class="form-check-label" for="exp15">15+ Years</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input filter-experience" type="checkbox" value="20" id="exp20">
                                    <label class="form-check-label" for="exp20">20+ Years</label>
                                </div>
                            </div>
                        </div>
                        

                        

                        
                        <!-- Additional Filters -->
                        <div class="mb-4">
                            <h6 class="mb-2 filter-section-title">
                                <i class="fas fa-sliders-h me-2"></i> Additional Filters
                                <span class="float-end">
                                    <button class="btn btn-sm btn-link p-0 text-decoration-none toggle-section" data-target="additionalFilterSection">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </span>
                            </h6>
                            <div id="additionalFilterSection">
                                <div class="form-check">
                                    <input class="form-check-input filter-additional" type="checkbox" value="available_today" id="availableToday">
                                    <label class="form-check-label" for="availableToday">Available Today</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input filter-additional" type="checkbox" value="verified" id="verified">
                                    <label class="form-check-label" for="verified">Verified Doctors</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input filter-additional" type="checkbox" value="online_consultation" id="onlineConsultation">
                                    <label class="form-check-label" for="onlineConsultation">Online Consultation</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input filter-additional" type="checkbox" value="female_doctors" id="femaleDoctors">
                                    <label class="form-check-label" for="femaleDoctors">Female Doctors</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sort By -->
                        <div class="mb-4">
                            <h6 class="mb-2">
                                <i class="fas fa-sort me-2"></i> Sort By
                            </h6>
                            <select class="form-select" id="sortDoctors" onchange="sortDoctorsList()">
                                <option value="experience_desc" {% if current_sort == 'experience_desc' %}selected{% endif %}>Experience: Most First</option>
                                <option value="experience_asc" {% if current_sort == 'experience_asc' %}selected{% endif %}>Experience: Least First</option>
                                <option value="name_asc" {% if current_sort == 'name_asc' %}selected{% endif %}>Name: A to Z</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-primary w-100 mb-2" id="applyDoctorFilters">
                            <i class="fas fa-filter me-1"></i> Apply Filters
                        </button>
                        
                        <button class="btn btn-outline-danger w-100" id="clearDoctorFilters">
                            <i class="fas fa-times-circle me-1"></i> Clear All Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Doctor List -->
        <div class="col-md-9">
            <div id="activeDoctorFilters" class="mb-3" style="display: none;">
                <h6 class="mb-2">Active Filters:</h6>
                <div class="d-flex flex-wrap gap-2" id="activeDoctorFilterBadges">
                    <!-- Active filter badges will be added here by JavaScript -->
                </div>
            </div>
            <div class="d-flex flex-column gap-2" id="doctorList">
                {% if doctors %}
                    {% for doctor in doctors %}
                        <div class="doctor-card" 
                             data-location="{{ doctor.city }}" 
                             data-specialty="{{ doctor.specialty }}">
                            <a href="{{ url_for('web.doctor_detail', doctor_id=doctor.id) }}" class="text-decoration-none">
                                <div class="card shadow-sm border-0 hover-shadow">
                                    <div class="card-body p-3">
                                        <div class="row align-items-center">
                                            <!-- Doctor Image -->
                                            <div class="col-auto">
                                                {% if doctor.profile_image %}
                                                    <img src="{{ doctor.profile_image }}" class="rounded-circle border" style="width: 70px; height: 70px; object-fit: cover;" alt="Dr. {{ doctor.name }}">
                                                {% else %}
                                                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;">
                                                        <i class="fas fa-user-md text-muted" style="font-size: 1.8rem;"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Doctor Info -->
                                            <div class="col">
                                                <div class="d-flex align-items-center mb-1">
                                                    <h5 class="mb-0 me-2">Dr. {{ doctor.name }}</h5>
                                                    {% if doctor.is_verified %}
                                                        <span class="badge bg-success bg-opacity-10 text-success small">
                                                            <i class="fas fa-check-circle"></i> Verified
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                
                                                <p class="text-muted mb-1">{{ doctor.specialty }}</p>
                                                <p class="text-muted small mb-2">{{ doctor.qualification|default('MBBS, MS, MCh') }}</p>
                                                
                                                <div class="row">
                                                    <div class="col-sm-6 col-12">
                                                        <div class="d-flex align-items-center text-muted small mb-1">
                                                            <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                            <span>{{ doctor.city }}{% if doctor.state %}, {{ doctor.state }}{% endif %}</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-6 col-12">
                                                        <div class="d-flex align-items-center text-muted small mb-1">
                                                            <i class="fas fa-briefcase text-primary me-2"></i>
                                                            <span>{{ doctor.experience|default(10) }} years experience</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Click indicator -->
                                            <div class="col-auto">
                                                <i class="fas fa-chevron-right text-muted"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-info">
                            No doctors available for your search criteria.
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Show More Button -->
            {% if has_more %}
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <button id="showMoreDoctors" class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-plus me-2"></i>
                        Show More Doctors
                        <span class="badge bg-primary ms-2">{{ total_count - showing_count }} more</span>
                    </button>
                </div>
            </div>
            {% endif %}

            <!-- Loading State -->
            <div id="loadingMoreDoctors" class="row mt-4" style="display: none;">
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading more doctors...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading more doctors...</p>
                </div>
            </div>

            <!-- Results Summary -->
            <div class="row mt-3">
                <div class="col-12 text-center">
                    <p class="text-muted mb-0">
                        <span id="showingDoctorsCount">{{ showing_count }}</span> of <span id="totalDoctorsCount">{{ total_count }}</span> doctors
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Consultation Modals for Each Doctor -->
{% for doctor in doctors %}
<div class="modal fade" id="bookConsultationModal{{ doctor.id }}" tabindex="-1" aria-labelledby="bookConsultationModalLabel{{ doctor.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookConsultationModalLabel{{ doctor.id }}">Book a Consultation with Dr. {{ doctor.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('web.submit_lead') }}" method="post">
                    <input type="hidden" name="doctor_id" value="{{ doctor.id }}">
                    <input type="hidden" name="source" value="Doctors List Page">
                    
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <label for="patient_name{{ doctor.id }}" class="form-label">Patient Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="patient_name{{ doctor.id }}" name="patient_name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="mobile_number{{ doctor.id }}" class="form-label">Mobile Number (10 digits) <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="mobile_number{{ doctor.id }}" name="mobile_number" pattern="[0-9]{10}" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <label for="city{{ doctor.id }}" class="form-label">Select City <span class="text-danger">*</span></label>
                            <select class="form-select" id="city{{ doctor.id }}" name="city" required>
                                <option value="" selected disabled>Select your city</option>
                                <option value="Hyderabad">Hyderabad</option>
                                <option value="Mumbai">Mumbai</option>
                                <option value="Delhi">Delhi</option>
                                <option value="Bangalore">Bangalore</option>
                                <option value="Chennai">Chennai</option>
                                <option value="Kolkata">Kolkata</option>
                                <option value="Pune">Pune</option>
                                <option value="Ahmedabad">Ahmedabad</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="preferred_date{{ doctor.id }}" class="form-label">Preferred Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="preferred_date{{ doctor.id }}" name="preferred_date" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="procedure_name{{ doctor.id }}" class="form-label">Select Procedure <span class="text-danger">*</span></label>
                        <select class="form-select" id="procedure_name{{ doctor.id }}" name="procedure_name" required>
                            <option value="" selected disabled>Select a procedure</option>
                            {% if doctor.doctor_procedures and doctor.doctor_procedures|length > 0 %}
                                {% for dp in doctor.doctor_procedures %}
                                    <option value="{{ dp.procedure.procedure_name }}">{{ dp.procedure.procedure_name }}</option>
                                {% endfor %}
                            {% else %}
                                <!-- Common procedures as fallback -->
                                <option value="Rhinoplasty">Rhinoplasty</option>
                                <option value="Breast Augmentation">Breast Augmentation</option>
                                <option value="Liposuction">Liposuction</option>
                                <option value="Facelift">Facelift</option>
                                <option value="Hair Transplant">Hair Transplant</option>
                                <option value="Dental Implants">Dental Implants</option>
                                <option value="LASIK Eye Surgery">LASIK Eye Surgery</option>
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="message{{ doctor.id }}" class="form-label">Additional Information</label>
                        <textarea class="form-control" id="message{{ doctor.id }}" name="message" rows="3" placeholder="Any specific concerns or questions?"></textarea>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="consent{{ doctor.id }}" name="consent" required>
                        <label class="form-check-label" for="consent{{ doctor.id }}">
                            I consent to data processing per Antidote's privacy policy as per DPDP Act 2023. <span class="text-danger">*</span>
                        </label>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">Submit Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/doctor-filters.js') }}"></script>
<script src="{{ url_for('static', filename='js/show-more-doctors.js') }}"></script>
<script>
    // Function to sort doctors by the selected criteria
    function sortDoctorsList() {
        const sortBy = document.getElementById('sortDoctors').value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('sort_by', sortBy);
        window.location.href = currentUrl.toString();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const doctorCards = document.querySelectorAll('.doctor-card');
        const searchInput = document.getElementById('doctorSearch');
        const clearFiltersBtn = document.getElementById('clearDoctorFilters');
        const applyFiltersBtn = document.getElementById('applyDoctorFilters');
        const sortSelect = document.getElementById('sortDoctors');
        
        // Track active filters
        let activeFilters = {
            search: '',
            locations: [],
            specialties: [],
            experiences: [],
            ratings: [],
            fees: [],
            additional: [],
            sortBy: 'relevance'
        };
        
        // Add data attributes to doctor cards for additional filtering
        doctorCards.forEach(card => {
            // Extract experience value from text (assuming format: "10 yrs experience")
            const experienceElement = card.querySelector('.fa-briefcase');
            if (experienceElement && experienceElement.parentNode) {
                const experienceText = experienceElement.parentNode.textContent;
                const experienceMatch = experienceText.match(/(\d+)\s*yrs/i);
                if (experienceMatch && experienceMatch[1]) {
                    card.setAttribute('data-experience', experienceMatch[1]);
                } else {
                    card.setAttribute('data-experience', '0');
                }
            } else {
                card.setAttribute('data-experience', '0');
            }
            
            // Extract rating value if it exists
            card.setAttribute('data-rating', Math.random() * 2 + 3); // Random rating between 3-5 for demo
            
            // Extract consultation fee
            const feeElement = card.querySelector('.fa-rupee-sign');
            if (feeElement && feeElement.parentNode) {
                const feeText = feeElement.parentNode.textContent;
                const feeMatch = feeText.match(/₹(\d+,*\d*)/);
                if (feeMatch && feeMatch[1]) {
                    card.setAttribute('data-fee', parseInt(feeMatch[1].replace(/,/g, '')));
                } else {
                    card.setAttribute('data-fee', '1500'); // Default value
                }
            } else {
                card.setAttribute('data-fee', '1500'); // Default value
            }
            
            // Set available today attribute
            const isAvailableToday = card.querySelector('.fa-calendar-check') !== null;
            card.setAttribute('data-available', isAvailableToday ? 'true' : 'false');
            
            // Set verified attribute
            const isVerified = card.querySelector('.badge.bg-success') !== null;
            card.setAttribute('data-verified', isVerified ? 'true' : 'false');
            
            // Set additional attributes for demo purposes
            card.setAttribute('data-online-consultation', Math.random() > 0.5 ? 'true' : 'false');
            card.setAttribute('data-gender', Math.random() > 0.7 ? 'female' : 'male');
            
            // Popularity for sorting (random for demo)
            card.setAttribute('data-popularity', Math.floor(Math.random() * 100));
        });
        
        // Function to apply all filters and sorting
        function applyFilters() {
            let visibleCount = 0;
            let visibleCards = [];
            
            // Get all active filter values
            activeFilters.locations = getCheckedValues('.filter-location');
            activeFilters.specialties = getCheckedValues('.filter-specialty');
            activeFilters.experiences = getCheckedValues('.filter-experience');
            activeFilters.ratings = getCheckedValues('.filter-rating');
            activeFilters.fees = getCheckedValues('.filter-fee');
            activeFilters.additional = getCheckedValues('.filter-additional');
            activeFilters.sortBy = sortSelect ? sortSelect.value : 'relevance';
            
            // Filter doctors
            doctorCards.forEach(card => {
                // Get card data
                const doctorName = card.querySelector('.card-title').textContent.toLowerCase();
                const specialty = card.dataset.specialty ? card.dataset.specialty.toLowerCase() : '';
                const location = card.dataset.location ? card.dataset.location.toLowerCase() : '';
                const experience = parseInt(card.dataset.experience || 0);
                const rating = parseFloat(card.dataset.rating || 0);
                const fee = parseInt(card.dataset.fee || 0);
                
                // Additional attributes
                const isAvailable = card.dataset.available === 'true';
                const isVerified = card.dataset.verified === 'true';
                const hasOnlineConsultation = card.dataset.onlineConsultation === 'true';
                const isFemale = card.dataset.gender === 'female';
                
                // Check all filter conditions
                const matchesSearch = activeFilters.search === '' || 
                                     doctorName.includes(activeFilters.search) || 
                                     specialty.includes(activeFilters.search);
                
                // Check if doctor matches any selected location
                const matchesLocation = activeFilters.locations.length === 0 || 
                                      activeFilters.locations.some(loc => 
                                          location.includes(loc.toLowerCase()));
                
                // Check if doctor matches any selected specialty
                const matchesSpecialty = activeFilters.specialties.length === 0 || 
                                       activeFilters.specialties.some(spec => 
                                           specialty.includes(spec.toLowerCase()));
                
                // Check if doctor has required experience
                const matchesExperience = activeFilters.experiences.length === 0 || 
                                        activeFilters.experiences.some(expYears => 
                                            experience >= parseInt(expYears));
                
                // Check if doctor has required rating
                const matchesRating = activeFilters.ratings.length === 0 || 
                                    activeFilters.ratings.some(minRating => 
                                        rating >= parseFloat(minRating));
                
                // Check consultation fee range
                const matchesFee = activeFilters.fees.length === 0 || 
                                  activeFilters.fees.some(feeRange => {
                                      const [min, max] = feeRange.split('-');
                                      if (min && max) {
                                          return fee >= parseInt(min) && fee <= parseInt(max);
                                      } else if (min && min.includes('+')) {
                                          const threshold = parseInt(min.replace('+', ''));
                                          return fee >= threshold;
                                      }
                                      return false;
                                  });
                
                // Check additional filters
                const matchesAdditional = !activeFilters.additional.some(filter => {
                    if (filter === 'available_today' && !isAvailable) return true;
                    if (filter === 'verified' && !isVerified) return true;
                    if (filter === 'online_consultation' && !hasOnlineConsultation) return true;
                    if (filter === 'female_doctors' && !isFemale) return true;
                    return false;
                });
                
                // Show or hide based on all filter conditions
                if (matchesSearch && matchesLocation && matchesSpecialty && 
                    matchesExperience && matchesRating && matchesFee && 
                    matchesAdditional) {
                    card.style.display = '';
                    visibleCount++;
                    visibleCards.push(card);
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Sort visible doctors
            if (visibleCards.length > 0) {
                sortDoctors(visibleCards);
            }
            
            // Update active filter badges
            updateActiveFilterBadges();
            
            // Show or hide "no results" message
            updateNoResultsMessage(visibleCount);
            
            // Update filter count badge
            updateFilterCountBadge();
        }
        
        // Helper function to get values from checked checkboxes
        function getCheckedValues(selector) {
            const values = [];
            document.querySelectorAll(`${selector}:checked`).forEach(checkbox => {
                values.push(checkbox.value);
            });
            return values;
        }
        
        // Sort doctors based on selected sorting option
        function sortDoctors(visibleCards) {
            const doctorList = document.getElementById('doctorList');
            
            // Sort based on active sort option
            visibleCards.sort((a, b) => {
                switch (activeFilters.sortBy) {
                    case 'rating_desc':
                        return parseFloat(b.getAttribute('data-rating')) - parseFloat(a.getAttribute('data-rating'));
                    case 'experience_desc':
                        return parseInt(b.getAttribute('data-experience')) - parseInt(a.getAttribute('data-experience'));
                    case 'fee_asc':
                        return parseInt(a.getAttribute('data-fee')) - parseInt(b.getAttribute('data-fee'));
                    case 'fee_desc':
                        return parseInt(b.getAttribute('data-fee')) - parseInt(a.getAttribute('data-fee'));
                    default: // relevance - maintain original order
                        return 0;
                }
            });
            
            // Reorder the cards in the DOM
            visibleCards.forEach(card => {
                doctorList.appendChild(card);
            });
        }
        
        // Update active filter badges
        function updateActiveFilterBadges() {
            const badgesContainer = document.getElementById('activeDoctorFilterBadges');
            const activeFiltersContainer = document.getElementById('activeDoctorFilters');
            
            // Clear existing badges
            badgesContainer.innerHTML = '';
            
            // Track if we have any active filters
            let hasActiveFilters = false;
            
            // Add badge for search
            if (activeFilters.search) {
                addFilterBadge('Search: ' + activeFilters.search, () => {
                    searchInput.value = '';
                    activeFilters.search = '';
                    applyFilters();
                });
                hasActiveFilters = true;
            }
            
            // Add badges for locations
            activeFilters.locations.forEach(location => {
                addFilterBadge('Location: ' + location, () => {
                    document.querySelector(`.filter-location[value="${location}"]`).checked = false;
                    activeFilters.locations = activeFilters.locations.filter(l => l !== location);
                    applyFilters();
                });
                hasActiveFilters = true;
            });
            
            // Add badges for specialties
            activeFilters.specialties.forEach(specialty => {
                addFilterBadge('Specialty: ' + specialty, () => {
                    document.querySelector(`.filter-specialty[value="${specialty}"]`).checked = false;
                    activeFilters.specialties = activeFilters.specialties.filter(s => s !== specialty);
                    applyFilters();
                });
                hasActiveFilters = true;
            });
            
            // Add badges for experience
            activeFilters.experiences.forEach(experience => {
                addFilterBadge('Experience: ' + experience + '+ Years', () => {
                    document.querySelector(`.filter-experience[value="${experience}"]`).checked = false;
                    activeFilters.experiences = activeFilters.experiences.filter(e => e !== experience);
                    applyFilters();
                });
                hasActiveFilters = true;
            });
            
            // Add badges for ratings
            activeFilters.ratings.forEach(rating => {
                addFilterBadge('Rating: ' + rating + '+ Stars', () => {
                    document.querySelector(`.filter-rating[value="${rating}"]`).checked = false;
                    activeFilters.ratings = activeFilters.ratings.filter(r => r !== rating);
                    applyFilters();
                });
                hasActiveFilters = true;
            });
            
            // Add badges for fees
            activeFilters.fees.forEach(fee => {
                let displayText = 'Fee: ';
                if (fee === '0-500') displayText += 'Up to ₹500';
                else if (fee === '500-1000') displayText += '₹500 - ₹1,000';
                else if (fee === '1000-2000') displayText += '₹1,000 - ₹2,000';
                else if (fee === '2000+') displayText += 'Above ₹2,000';
                
                addFilterBadge(displayText, () => {
                    document.querySelector(`.filter-fee[value="${fee}"]`).checked = false;
                    activeFilters.fees = activeFilters.fees.filter(f => f !== fee);
                    applyFilters();
                });
                hasActiveFilters = true;
            });
            
            // Add badges for additional filters
            activeFilters.additional.forEach(additional => {
                let displayText = '';
                if (additional === 'available_today') displayText = 'Available Today';
                else if (additional === 'verified') displayText = 'Verified Doctors';
                else if (additional === 'online_consultation') displayText = 'Online Consultation';
                else if (additional === 'female_doctors') displayText = 'Female Doctors';
                
                addFilterBadge(displayText, () => {
                    document.querySelector(`.filter-additional[value="${additional}"]`).checked = false;
                    activeFilters.additional = activeFilters.additional.filter(a => a !== additional);
                    applyFilters();
                });
                hasActiveFilters = true;
            });
            
            // Show or hide the active filters section
            if (hasActiveFilters) {
                activeFiltersContainer.style.display = 'block';
            } else {
                activeFiltersContainer.style.display = 'none';
            }
            
            // Helper function to add a filter badge
            function addFilterBadge(text, removeCallback) {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary d-flex align-items-center gap-2 py-2 px-3';
                badge.innerHTML = `
                    ${text}
                    <button type="button" class="btn-close btn-close-white p-0" aria-label="Remove filter"></button>
                `;
                badge.querySelector('.btn-close').addEventListener('click', removeCallback);
                badgesContainer.appendChild(badge);
            }
        }
        
        // Update the filter count badge
        function updateFilterCountBadge() {
            const countBadge = document.querySelector('.doctor-filter-count');
            const filterCount = 
                (activeFilters.search ? 1 : 0) +
                activeFilters.locations.length +
                activeFilters.specialties.length +
                activeFilters.experiences.length +
                activeFilters.ratings.length +
                activeFilters.fees.length +
                activeFilters.additional.length;
            
            if (filterCount > 0) {
                countBadge.textContent = filterCount;
                countBadge.style.display = '';
            } else {
                countBadge.style.display = 'none';
            }
        }
        
        // Update or show "no results" message
        function updateNoResultsMessage(visibleCount) {
            // Remove existing message if it exists
            const existingMessage = document.querySelector('.no-results-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Add new message if needed
            if (visibleCount === 0) {
                const doctorList = document.getElementById('doctorList');
                const noResultsEl = document.createElement('div');
                noResultsEl.className = 'col-12 no-results-message';
                noResultsEl.innerHTML = `
                    <div class="alert alert-info">
                        <h5 class="alert-heading"><i class="fas fa-search me-2"></i> No doctors found</h5>
                        <p>No doctors match your current filter criteria. Try adjusting your filters to see more results.</p>
                    </div>
                `;
                doctorList.appendChild(noResultsEl);
            }
        }
        
        // Toggle filter sections
        document.querySelectorAll('.toggle-section').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const targetSection = document.getElementById(targetId);
                const icon = this.querySelector('i');
                
                if (targetSection.style.display === 'none') {
                    targetSection.style.display = 'block';
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                } else {
                    targetSection.style.display = 'none';
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            });
        });
        
        // Search input handler - real-time filtering
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                activeFilters.search = this.value.toLowerCase();
                applyFilters();
            });
        }
        
        // Add change listeners to all filter checkboxes
        document.querySelectorAll('.filter-location, .filter-specialty, .filter-experience, .filter-additional').forEach(checkbox => {
            checkbox.addEventListener('change', applyFilters);
        });
        
        // Sort select handler
        if (sortSelect) {
            sortSelect.addEventListener('change', function() {
                activeFilters.sortBy = this.value;
                applyFilters();
            });
        }
        
        // Apply filters button handler
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', applyFilters);
        }
        
        // Clear all filters
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function() {
                // Reset all checkboxes
                document.querySelectorAll('.filter-location, .filter-specialty, .filter-experience, .filter-additional').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Reset sort to default
                if (sortSelect) {
                    sortSelect.value = 'relevance';
                }
                
                // Clear search
                if (searchInput) {
                    searchInput.value = '';
                }
                
                // Reset all active filters
                activeFilters = {
                    search: '',
                    locations: [],
                    specialties: [],
                    experiences: [],
                    additional: [],
                    sortBy: 'relevance'
                };
                
                // Apply cleared filters
                applyFilters();
            });
        }
        
        // Initialize the filter system
        applyFilters();

        // Show More functionality moved to separate file: show-more-doctors.js
        }

        // Function to create doctor card HTML
        function createDoctorCard(doctor) {
            let imageHtml = '';
            if (doctor.profile_image) {
                imageHtml = '<img src="' + doctor.profile_image + '" alt="Dr. ' + doctor.name + '" class="rounded-circle" width="80" height="80" style="object-fit: cover;">';
            } else {
                imageHtml = '<div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white" style="width: 80px; height: 80px; font-size: 1.8rem; font-weight: bold;">' + 
                           doctor.name.charAt(0).toUpperCase() + '</div>';
            }
            
            let ratingHtml = '';
            if (doctor.rating) {
                ratingHtml = '<span class="badge bg-warning text-dark d-flex align-items-center"><i class="fas fa-star me-1"></i>' + doctor.rating + '</span>';
            }
            
            return '<div class="col-md-6 col-lg-4 mb-3">' +
                   '<div class="doctor-card" data-location="' + (doctor.city || '') + '" data-specialty="' + (doctor.specialty || '') + '">' +
                   '<a href="/doctor/' + doctor.id + '" class="text-decoration-none">' +
                   '<div class="card shadow-sm border-0 hover-shadow">' +
                   '<div class="card-body p-3">' +
                   '<div class="row align-items-center">' +
                   '<div class="col-auto">' + imageHtml + '</div>' +
                   '<div class="col">' +
                   '<div class="d-flex justify-content-between align-items-start mb-2">' +
                   '<h5 class="mb-0">Dr. ' + doctor.name + '</h5>' + ratingHtml +
                   '</div>' +
                   '<p class="text-muted mb-1">' + (doctor.specialty || 'Aesthetic Surgery') + '</p>' +
                   '<p class="text-muted small mb-2">MBBS, MS, MCh</p>' +
                   '<div class="row">' +
                   '<div class="col-sm-6 col-12">' +
                   '<div class="d-flex align-items-center text-muted small mb-1">' +
                   '<i class="fas fa-map-marker-alt text-danger me-2"></i>' +
                   '<span>' + (doctor.city || 'Available') + '</span>' +
                   '</div>' +
                   '</div>' +
                   '<div class="col-sm-6 col-12">' +
                   '<div class="d-flex align-items-center text-muted small mb-1">' +
                   '<i class="fas fa-briefcase text-primary me-2"></i>' +
                   '<span>' + (doctor.experience || 10) + ' yrs experience</span>' +
                   '</div>' +
                   '</div>' +
                   '</div>' +
                   '</div>' +
                   '<div class="col-auto">' +
                   '<i class="fas fa-chevron-right text-muted"></i>' +
                   '</div>' +
                   '</div>' +
                   '</div>' +
                   '</div>' +
                   '</a>' +
                   '</div>' +
                   '</div>';
        }
    });
</script>
{% endblock %}
