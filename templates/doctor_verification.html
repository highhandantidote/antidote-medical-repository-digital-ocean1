{% extends 'base.html' %}

{% block title %}Verification | Doctor Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card bg-dark text-white mb-4">
                <div class="card-body">
                    <h4>Doctor Profile</h4>
                    <p>{{ doctor.name }}</p>
                    <p>â˜… {{ doctor.rating }} ({{ doctor.review_count }} reviews)</p>
                    <a href="#" class="btn btn-outline-primary">Edit Profile</a>

                    <h4 class="mt-4">Dashboard Menu</h4>
                    <ul class="list-group">
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_dashboard', doctor_id=doctor.id) }}" class="text-white">Overview</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_dashboard', doctor_id=doctor.id) }}#appointments" class="text-white">Appointments</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_leads', doctor_id=doctor.id) }}" class="text-white">Patient Leads</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_dashboard', doctor_id=doctor.id) }}#reviews" class="text-white">Reviews</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_procedures', doctor_id=doctor.id) }}" class="text-white">My Procedures</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_availability', doctor_id=doctor.id) }}" class="text-white">Availability</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_gallery', doctor_id=doctor.id) }}" class="text-white">Gallery</a></li>
                        <li class="list-group-item bg-dark text-white"><a href="{{ url_for('web.doctor_community', doctor_id=doctor.id) }}" class="text-white">Community</a></li>
                        <li class="list-group-item bg-dark text-white active"><a href="{{ url_for('web.doctor_verification', doctor_id=doctor.id) }}" class="text-white">Verification <span class="badge bg-warning">NEW</span></a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Verification Benefits -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Benefits of Verification</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li class="mb-2">Verified badge builds patient trust</li>
                        <li class="mb-2">Higher ranking in search results</li>
                        <li class="mb-2">50% more patient engagement</li>
                        <li class="mb-2">Access to expert community status</li>
                        <li>Featured in specialty promotions</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9">
            <div class="card bg-dark text-white mb-4">
                <div class="card-header">
                    <h3 class="mb-0">Verification Status</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="verification-status-box p-4 text-center mb-4 
                                        {% if doctor.verification_status == 'approved' %}
                                            border border-success
                                        {% elif doctor.verification_status == 'pending' %}
                                            border border-warning
                                        {% elif doctor.verification_status == 'rejected' %}
                                            border border-danger
                                        {% else %}
                                            border border-secondary
                                        {% endif %}">
                                
                                {% if doctor.verification_status == 'approved' %}
                                    <div class="display-1 text-success mb-3">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <h4 class="text-success">Verified</h4>
                                    <p class="mb-0">Your profile has been fully verified</p>
                                    <small class="text-muted">Verification valid until {{ (doctor.verification_date + timedelta(days=365)).strftime('%b %d, %Y') if doctor.verification_date else 'N/A' }}</small>
                                    
                                {% elif doctor.verification_status == 'pending' %}
                                    <div class="display-1 text-warning mb-3">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <h4 class="text-warning">Under Review</h4>
                                    <p class="mb-0">Your verification is being processed</p>
                                    <small class="text-muted">Submitted on {{ doctor.verification_date.strftime('%b %d, %Y') if doctor.verification_date else 'N/A' }}</small>
                                    
                                {% elif doctor.verification_status == 'rejected' %}
                                    <div class="display-1 text-danger mb-3">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <h4 class="text-danger">Verification Failed</h4>
                                    <p class="mb-0">Please review the reason and resubmit</p>
                                    <small class="text-muted">Last updated on {{ doctor.verification_date.strftime('%b %d, %Y') if doctor.verification_date else 'N/A' }}</small>
                                    
                                {% else %}
                                    <div class="display-1 text-secondary mb-3">
                                        <i class="fas fa-user-md"></i>
                                    </div>
                                    <h4 class="text-white">Not Verified</h4>
                                    <p class="mb-0">Complete verification to unlock benefits</p>
                                    <small class="text-muted">Submit your credentials to get started</small>
                                {% endif %}
                            </div>
                            
                            {% if doctor.verification_status == 'rejected' %}
                                <div class="alert alert-danger">
                                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Reason for Rejection</h5>
                                    <p>{{ doctor.verification_notes or 'Your verification documents could not be validated. Please resubmit with clearer images or additional documentation.' }}</p>
                                </div>
                            {% endif %}
                            
                            {% if doctor.verification_status != 'pending' %}
                                <div class="text-center mt-3">
                                    <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#verificationModal">
                                        {% if doctor.verification_status == 'approved' %}
                                            <i class="fas fa-sync-alt me-2"></i> Renew Verification
                                        {% elif doctor.verification_status == 'rejected' %}
                                            <i class="fas fa-redo me-2"></i> Resubmit Verification
                                        {% else %}
                                            <i class="fas fa-user-check me-2"></i> Start Verification
                                        {% endif %}
                                    </button>
                                </div>
                            {% else %}
                                <div class="alert alert-info text-center">
                                    <p class="mb-0"><i class="fas fa-info-circle me-2"></i> Your verification is currently being reviewed by our team. This typically takes 1-3 business days.</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h5>Verification Checklist</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-id-card me-2"></i> Medical License
                                        <small class="d-block text-muted">Valid medical registration number</small>
                                    </div>
                                    <span class="badge {{ 'bg-success' if doctor.medical_license_number else 'bg-secondary' }} rounded-pill">
                                        {% if doctor.medical_license_number %}
                                            <i class="fas fa-check"></i>
                                        {% else %}
                                            <i class="fas fa-times"></i>
                                        {% endif %}
                                    </span>
                                </li>
                                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-user-md me-2"></i> Identity Verification
                                        <small class="d-block text-muted">Aadhaar card or other government ID</small>
                                    </div>
                                    <span class="badge {{ 'bg-success' if doctor.aadhaar_number else 'bg-secondary' }} rounded-pill">
                                        {% if doctor.aadhaar_number %}
                                            <i class="fas fa-check"></i>
                                        {% else %}
                                            <i class="fas fa-times"></i>
                                        {% endif %}
                                    </span>
                                </li>
                                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-graduation-cap me-2"></i> Education Credentials
                                        <small class="d-block text-muted">Medical degree and specialization certificates</small>
                                    </div>
                                    <span class="badge {{ 'bg-success' if doctor.credentials_url else 'bg-secondary' }} rounded-pill">
                                        {% if doctor.credentials_url %}
                                            <i class="fas fa-check"></i>
                                        {% else %}
                                            <i class="fas fa-times"></i>
                                        {% endif %}
                                    </span>
                                </li>
                                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-hospital me-2"></i> Practice Information
                                        <small class="d-block text-muted">Clinic/hospital details and registration</small>
                                    </div>
                                    <span class="badge {{ 'bg-success' if doctor.practice_location else 'bg-secondary' }} rounded-pill">
                                        {% if doctor.practice_location %}
                                            <i class="fas fa-check"></i>
                                        {% else %}
                                            <i class="fas fa-times"></i>
                                        {% endif %}
                                    </span>
                                </li>
                                <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-certificate me-2"></i> Specialty Certification
                                        <small class="d-block text-muted">Relevant board certifications</small>
                                    </div>
                                    <span class="badge {{ 'bg-success' if doctor.specialty and doctor.certifications else 'bg-secondary' }} rounded-pill">
                                        {% if doctor.specialty and doctor.certifications %}
                                            <i class="fas fa-check"></i>
                                        {% else %}
                                            <i class="fas fa-times"></i>
                                        {% endif %}
                                    </span>
                                </li>
                            </ul>
                            
                            <div class="mt-4">
                                <h5>Uploaded Documents</h5>
                                {% if doctor.credentials_url %}
                                    <div class="card bg-dark text-white mb-2">
                                        <div class="card-body py-2 px-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-file-pdf me-2"></i> credentials.pdf
                                                </div>
                                                <a href="{{ doctor.credentials_url }}" target="_blank" class="btn btn-sm btn-outline-light">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="alert alert-secondary">
                                        <i class="fas fa-file-upload me-2"></i> No documents uploaded yet
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Verification Timeline -->
            <div class="card bg-dark text-white">
                <div class="card-header">
                    <h4 class="mb-0">Verification Timeline</h4>
                </div>
                <div class="card-body">
                    {% if verification_events %}
                        <div class="timeline">
                            {% for event in verification_events %}
                                <div class="timeline-item">
                                    <div class="timeline-date">{{ event.created_at.strftime('%b %d') }}</div>
                                    <div class="timeline-icon 
                                        {% if event.status == 'submitted' %}
                                            bg-primary
                                        {% elif event.status == 'in_review' %}
                                            bg-warning
                                        {% elif event.status == 'approved' %}
                                            bg-success
                                        {% elif event.status == 'rejected' %}
                                            bg-danger
                                        {% else %}
                                            bg-secondary
                                        {% endif %}
                                    ">
                                        {% if event.status == 'submitted' %}
                                            <i class="fas fa-paper-plane"></i>
                                        {% elif event.status == 'in_review' %}
                                            <i class="fas fa-search"></i>
                                        {% elif event.status == 'approved' %}
                                            <i class="fas fa-check"></i>
                                        {% elif event.status == 'rejected' %}
                                            <i class="fas fa-times"></i>
                                        {% else %}
                                            <i class="fas fa-circle"></i>
                                        {% endif %}
                                    </div>
                                    <div class="timeline-content">
                                        <h5>{{ event.title }}</h5>
                                        <p>{{ event.description }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        {% if doctor.verification_status %}
                            <div class="timeline">
                                {% if doctor.verification_status == 'pending' %}
                                    <div class="timeline-item">
                                        <div class="timeline-date">{{ doctor.verification_date.strftime('%b %d') if doctor.verification_date else 'Today' }}</div>
                                        <div class="timeline-icon bg-primary">
                                            <i class="fas fa-paper-plane"></i>
                                        </div>
                                        <div class="timeline-content">
                                            <h5>Documents Submitted</h5>
                                            <p>Your verification documents have been submitted successfully and are awaiting review.</p>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-date">Pending</div>
                                        <div class="timeline-icon bg-secondary">
                                            <i class="fas fa-search"></i>
                                        </div>
                                        <div class="timeline-content">
                                            <h5>Document Review</h5>
                                            <p>Our team will verify your medical credentials and identification documents.</p>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-date">Pending</div>
                                        <div class="timeline-icon bg-secondary">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <div class="timeline-content">
                                            <h5>Verification Complete</h5>
                                            <p>Once verified, your profile will display a verification badge to build patient trust.</p>
                                        </div>
                                    </div>
                                {% elif doctor.verification_status == 'approved' %}
                                    <div class="timeline-item">
                                        <div class="timeline-date">{{ (doctor.verification_date - timedelta(days=7)).strftime('%b %d') if doctor.verification_date else 'N/A' }}</div>
                                        <div class="timeline-icon bg-primary">
                                            <i class="fas fa-paper-plane"></i>
                                        </div>
                                        <div class="timeline-content">
                                            <h5>Documents Submitted</h5>
                                            <p>Your verification documents were submitted successfully.</p>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-date">{{ (doctor.verification_date - timedelta(days=3)).strftime('%b %d') if doctor.verification_date else 'N/A' }}</div>
                                        <div class="timeline-icon bg-warning">
                                            <i class="fas fa-search"></i>
                                        </div>
                                        <div class="timeline-content">
                                            <h5>Document Review</h5>
                                            <p>Our team reviewed your medical credentials and identification documents.</p>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-date">{{ doctor.verification_date.strftime('%b %d') if doctor.verification_date else 'N/A' }}</div>
                                        <div class="timeline-icon bg-success">
                                            <i class="fas fa-check"></i>
                                        </div>
                                        <div class="timeline-content">
                                            <h5>Verification Complete</h5>
                                            <p>Congratulations! Your profile has been verified and now displays the verification badge.</p>
                                        </div>
                                    </div>
                                {% elif doctor.verification_status == 'rejected' %}
                                    <div class="timeline-item">
                                        <div class="timeline-date">{{ (doctor.verification_date - timedelta(days=7)).strftime('%b %d') if doctor.verification_date else 'N/A' }}</div>
                                        <div class="timeline-icon bg-primary">
                                            <i class="fas fa-paper-plane"></i>
                                        </div>
                                        <div class="timeline-content">
                                            <h5>Documents Submitted</h5>
                                            <p>Your verification documents were submitted for review.</p>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-date">{{ (doctor.verification_date - timedelta(days=3)).strftime('%b %d') if doctor.verification_date else 'N/A' }}</div>
                                        <div class="timeline-icon bg-warning">
                                            <i class="fas fa-search"></i>
                                        </div>
                                        <div class="timeline-content">
                                            <h5>Document Review</h5>
                                            <p>Our team reviewed your submitted documents and found issues that need to be addressed.</p>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-date">{{ doctor.verification_date.strftime('%b %d') if doctor.verification_date else 'N/A' }}</div>
                                        <div class="timeline-icon bg-danger">
                                            <i class="fas fa-times"></i>
                                        </div>
                                        <div class="timeline-content">
                                            <h5>Verification Failed</h5>
                                            <p>{{ doctor.verification_notes or 'Your documents could not be verified. Please review and resubmit with the required corrections.' }}</p>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i> No verification activity yet. Start the verification process to build patient trust.
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Verification Modal -->
<div class="modal fade" id="verificationModal" tabindex="-1" aria-labelledby="verificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="verificationModalLabel">
                    {% if doctor.verification_status == 'approved' %}
                        Renew Verification
                    {% elif doctor.verification_status == 'rejected' %}
                        Resubmit Verification
                    {% else %}
                        Doctor Verification
                    {% endif %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('web.submit_verification', doctor_id=doctor.id) }}" method="POST" enctype="multipart/form-data" id="verificationForm">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> 
                        {% if doctor.verification_status == 'approved' %}
                            Your current verification is valid, but you can renew or update your credentials if needed.
                        {% elif doctor.verification_status == 'rejected' %}
                            Please address the issues mentioned in the rejection reason and resubmit your verification.
                        {% else %}
                            Complete all required fields below to verify your doctor profile. This helps build trust with potential patients.
                        {% endif %}
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="medicalLicenseNumber" class="form-label">Medical License Number *</label>
                            <input type="text" class="form-control" id="medicalLicenseNumber" name="medical_license_number" value="{{ doctor.medical_license_number or '' }}" required>
                            <div class="form-text">Your medical council registration number (e.g., MCI/NMC/SMC number)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="aadhaarNumber" class="form-label">Aadhaar Number *</label>
                            <input type="text" class="form-control" id="aadhaarNumber" name="aadhaar_number" value="{{ doctor.aadhaar_number or '' }}" required>
                            <div class="form-text">Your 12-digit Aadhaar number for identity verification</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="qualification" class="form-label">Highest Qualification *</label>
                            <input type="text" class="form-control" id="qualification" name="qualification" value="{{ doctor.qualification or '' }}" required>
                            <div class="form-text">Your highest medical degree (e.g., MBBS, MS, MCh)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="practiceLocation" class="form-label">Primary Practice Location *</label>
                            <input type="text" class="form-control" id="practiceLocation" name="practice_location" value="{{ doctor.practice_location or '' }}" required>
                            <div class="form-text">Main clinic or hospital where you practice</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="credentials" class="form-label">Upload Credentials *</label>
                        <input type="file" class="form-control" id="credentials" name="credentials" {% if not doctor.credentials_url %}required{% endif %}>
                        <div class="form-text">Upload a PDF or image containing your medical degree, license, and specialty certification. Maximum 5MB.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="specialty" class="form-label">Specialty *</label>
                        <select class="form-select" id="specialty" name="specialty" required>
                            <option value="">-- Select your specialty --</option>
                            <option value="Plastic Surgery" {% if doctor.specialty == 'Plastic Surgery' %}selected{% endif %}>Plastic Surgery</option>
                            <option value="Cosmetic Surgery" {% if doctor.specialty == 'Cosmetic Surgery' %}selected{% endif %}>Cosmetic Surgery</option>
                            <option value="Reconstructive Surgery" {% if doctor.specialty == 'Reconstructive Surgery' %}selected{% endif %}>Reconstructive Surgery</option>
                            <option value="Aesthetic Medicine" {% if doctor.specialty == 'Aesthetic Medicine' %}selected{% endif %}>Aesthetic Medicine</option>
                            <option value="Dermatology" {% if doctor.specialty == 'Dermatology' %}selected{% endif %}>Dermatology</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Certifications</label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="certAsps" name="certifications[]" value="ASPS" {% if doctor.certifications and 'ASPS' in doctor.certifications %}checked{% endif %}>
                                    <label class="form-check-label" for="certAsps">ASPS (American Society of Plastic Surgeons)</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="certApsi" name="certifications[]" value="APSI" {% if doctor.certifications and 'APSI' in doctor.certifications %}checked{% endif %}>
                                    <label class="form-check-label" for="certApsi">APSI (Association of Plastic Surgeons of India)</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="certIsaps" name="certifications[]" value="ISAPS" {% if doctor.certifications and 'ISAPS' in doctor.certifications %}checked{% endif %}>
                                    <label class="form-check-label" for="certIsaps">ISAPS (International Society of Aesthetic Plastic Surgery)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="termsAgreement" name="terms_agreement" required>
                        <label class="form-check-label" for="termsAgreement">
                            I confirm that all information provided is accurate and I authorize Antidote to verify my credentials through appropriate channels.
                        </label>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="dpdpConsent" name="dpdp_consent" required>
                        <label class="form-check-label" for="dpdpConsent">
                            I consent to the processing of my data in accordance with the DPDP Act 2023.
                        </label>
                    </div>
                    
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            {% if doctor.verification_status == 'approved' %}
                                Renew Verification
                            {% elif doctor.verification_status == 'rejected' %}
                                Resubmit Verification
                            {% else %}
                                Submit for Verification
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Timeline styles */
    .timeline {
        position: relative;
        padding: 0;
        margin: 0;
    }
    
    .timeline-item {
        position: relative;
        padding-left: 40px;
        margin-bottom: 25px;
    }
    
    .timeline-date {
        font-size: 0.85rem;
        color: #aaa;
        margin-bottom: 5px;
    }
    
    .timeline-icon {
        position: absolute;
        left: 0;
        top: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    
    .timeline-content {
        background-color: #2a2a2a;
        padding: 15px;
        border-radius: 5px;
    }
    
    .timeline-content h5 {
        margin-top: 0;
        margin-bottom: 10px;
    }
    
    .timeline-content p {
        margin-bottom: 0;
        color: #ddd;
    }
    
    .timeline:before {
        content: '';
        position: absolute;
        top: 0;
        left: 15px;
        height: 100%;
        width: 2px;
        background-color: #555;
    }
    
    .verification-status-box {
        border-radius: 10px;
        background-color: rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}