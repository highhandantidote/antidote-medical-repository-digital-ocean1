{% extends 'base.html' %}

{% block title %}Doctor Verifications - Antidote Admin{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('web.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('web.admin_dashboard') }}">Admin Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Doctor Verifications</li>
                </ol>
            </nav>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    <div class="row">
        <div class="col-md-3">
            <!-- Sidebar -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Filter By Status</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('web.admin_doctor_verifications', status='pending', location=location) }}" 
                       class="list-group-item list-group-item-action bg-dark text-white border-light {% if status == 'pending' %}active{% endif %}">
                        Pending <span class="badge bg-warning text-dark float-end">{{ doctors|selectattr('verification_status', 'equalto', 'pending')|list|length }}</span>
                    </a>
                    <a href="{{ url_for('web.admin_doctor_verifications', status='approved', location=location) }}" 
                       class="list-group-item list-group-item-action bg-dark text-white border-light {% if status == 'approved' %}active{% endif %}">
                        Approved <span class="badge bg-success float-end">{{ doctors|selectattr('verification_status', 'equalto', 'approved')|list|length }}</span>
                    </a>
                    <a href="{{ url_for('web.admin_doctor_verifications', status='rejected', location=location) }}" 
                       class="list-group-item list-group-item-action bg-dark text-white border-light {% if status == 'rejected' %}active{% endif %}">
                        Rejected <span class="badge bg-danger float-end">{{ doctors|selectattr('verification_status', 'equalto', 'rejected')|list|length }}</span>
                    </a>
                    <a href="{{ url_for('web.admin_doctor_verifications') }}" 
                       class="list-group-item list-group-item-action bg-dark text-white border-light {% if not status %}active{% endif %}">
                        All <span class="badge bg-info float-end">{{ doctors|length }}</span>
                    </a>
                </div>
            </div>
            
            <!-- Location Filter -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Filter By Location</h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('web.admin_doctor_verifications') }}">
                        <input type="hidden" name="status" value="{{ status }}">
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location" value="{{ location }}" placeholder="City or state">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
                    </form>
                    {% if location %}
                    <div class="mt-2">
                        <a href="{{ url_for('web.admin_doctor_verifications', status=status) }}" class="btn btn-outline-secondary w-100">Clear Location Filter</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card bg-dark text-white mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Doctor Verification Requests</h5>
                    <span class="badge bg-primary">{{ doctors|length }} Total</span>
                </div>
                <div class="card-body">
                    {% if doctors %}
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Doctor</th>
                                        <th>License Number</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for doctor in doctors %}
                                        <tr data-doctor-id="{{ doctor.id }}">
                                            <td>
                                                {% if doctor.user %}
                                                    {{ doctor.user.username }}
                                                {% else %}
                                                    {{ doctor.name }}
                                                {% endif %}
                                            </td>
                                            <td>{{ doctor.medical_license_number }}</td>
                                            <td>{{ doctor.practice_location }}</td>
                                            <td>
                                                {% if doctor.verification_status == 'pending' %}
                                                    <span class="badge bg-warning text-dark">Pending</span>
                                                {% elif doctor.verification_status == 'approved' %}
                                                    <span class="badge bg-success">Approved</span>
                                                {% elif doctor.verification_status == 'rejected' %}
                                                    <span class="badge bg-danger">Rejected</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Unknown</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ doctor.created_at.strftime('%b %d, %Y') }}</td>
                                            <td>
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-sm btn-outline-info view-credentials" 
                                                            data-bs-toggle="modal" data-bs-target="#credentialsModal"
                                                            data-doctor-id="{{ doctor.id }}"
                                                            data-doctor-name="{% if doctor.user %}{{ doctor.user.username }}{% else %}{{ doctor.name }}{% endif %}"
                                                            data-license="{{ doctor.medical_license_number }}"
                                                            data-qualification="{{ doctor.qualification }}"
                                                            data-location="{{ doctor.practice_location }}"
                                                            data-aadhaar="{{ doctor.aadhaar_number or '' }}"
                                                            data-credentials="{{ doctor.credentials_url or '' }}">
                                                        View
                                                    </button>
                                                    {% if doctor.verification_status == 'pending' %}
                                                        <button type="button" class="btn btn-sm btn-outline-success approve-doctor" data-doctor-id="{{ doctor.id }}">
                                                            Approve
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger reject-doctor" 
                                                                data-bs-toggle="modal" data-bs-target="#rejectModal"
                                                                data-doctor-id="{{ doctor.id }}"
                                                                data-doctor-name="{% if doctor.user %}{{ doctor.user.username }}{% else %}{{ doctor.name }}{% endif %}">
                                                            Reject
                                                        </button>
                                                    {% elif doctor.verification_status == 'approved' %}
                                                        <button type="button" class="btn btn-sm btn-outline-danger reject-doctor" 
                                                                data-bs-toggle="modal" data-bs-target="#rejectModal"
                                                                data-doctor-id="{{ doctor.id }}"
                                                                data-doctor-name="{% if doctor.user %}{{ doctor.user.username }}{% else %}{{ doctor.name }}{% endif %}">
                                                            Revoke
                                                        </button>
                                                    {% elif doctor.verification_status == 'rejected' %}
                                                        <button type="button" class="btn btn-sm btn-outline-success approve-doctor" data-doctor-id="{{ doctor.id }}">
                                                            Approve
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-user-md fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">No doctor verification requests found matching your criteria</p>
                            {% if status or location %}
                                <a href="{{ url_for('web.admin_doctor_verifications') }}" class="btn btn-outline-info">Clear All Filters</a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Credentials Modal -->
<div class="modal fade" id="credentialsModal" tabindex="-1" aria-labelledby="credentialsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="credentialsModalLabel">Doctor Credentials</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <p class="fw-bold mb-1">Doctor:</p>
                        <p id="modal-doctor-name"></p>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold mb-1">License:</p>
                        <p id="modal-license"></p>
                    </div>
                    <div class="col-md-4">
                        <p class="fw-bold mb-1">Location:</p>
                        <p id="modal-location"></p>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <p class="fw-bold mb-1">Qualifications:</p>
                        <p id="modal-qualification"></p>
                    </div>
                </div>
                
                <div class="row mb-3" id="aadhaar-row">
                    <div class="col-12">
                        <p class="fw-bold mb-1">Aadhaar Number (India):</p>
                        <p id="modal-aadhaar"></p>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <p class="fw-bold mb-1">Credentials Document:</p>
                        <div id="credentials-container" class="d-flex justify-content-center align-items-center">
                            <div id="no-credentials" class="text-center py-4" style="display: none;">
                                <i class="fas fa-file-alt fa-3x mb-3 text-muted"></i>
                                <p class="text-muted">No credentials document available</p>
                            </div>
                            <div id="credentials-preview" style="max-height: 400px; overflow-y: auto;">
                                <!-- Credentials will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success modal-approve-btn" id="modal-approve-btn">Approve</button>
                <button type="button" class="btn btn-danger modal-reject-btn" id="modal-reject-btn"
                        data-bs-toggle="modal" data-bs-target="#rejectModal">Reject</button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">Reject Doctor Verification</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You are about to reject the verification request for <span id="reject-doctor-name" class="fw-bold"></span>.</p>
                <div class="mb-3">
                    <label for="reject-reason" class="form-label">Reason for Rejection:</label>
                    <textarea class="form-control" id="reject-reason" rows="3" placeholder="Please provide a reason for rejection..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-reject-btn">Confirm Rejection</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentDoctorId = null;
        
        // View credentials button
        document.querySelectorAll('.view-credentials').forEach(button => {
            button.addEventListener('click', function() {
                const doctorId = this.getAttribute('data-doctor-id');
                const doctorName = this.getAttribute('data-doctor-name');
                const license = this.getAttribute('data-license');
                const qualification = this.getAttribute('data-qualification');
                const location = this.getAttribute('data-location');
                const aadhaar = this.getAttribute('data-aadhaar');
                const credentials = this.getAttribute('data-credentials');
                
                currentDoctorId = doctorId;
                
                // Update modal content
                document.getElementById('modal-doctor-name').textContent = doctorName;
                document.getElementById('modal-license').textContent = license;
                document.getElementById('modal-qualification').textContent = qualification || 'Not provided';
                document.getElementById('modal-location').textContent = location || 'Not provided';
                
                // Handle Aadhaar number
                if (aadhaar && aadhaar.trim() !== '') {
                    document.getElementById('modal-aadhaar').textContent = aadhaar;
                    document.getElementById('aadhaar-row').style.display = 'block';
                } else {
                    document.getElementById('aadhaar-row').style.display = 'none';
                }
                
                // Handle credentials document
                const credentialsContainer = document.getElementById('credentials-preview');
                const noCredentials = document.getElementById('no-credentials');
                
                if (credentials && credentials.trim() !== '') {
                    noCredentials.style.display = 'none';
                    credentialsContainer.style.display = 'block';
                    
                    // Check file type to determine how to display it
                    if (credentials.toLowerCase().endsWith('.pdf')) {
                        credentialsContainer.innerHTML = `
                            <embed src="/static/doctor_credentials/${credentials}" type="application/pdf" width="100%" height="400px" />
                        `;
                    } else if (credentials.toLowerCase().match(/\.(jpeg|jpg|png|gif)$/)) {
                        credentialsContainer.innerHTML = `
                            <img src="/static/doctor_credentials/${credentials}" class="img-fluid" alt="Doctor Credentials" />
                        `;
                    } else {
                        credentialsContainer.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-file me-2"></i> ${credentials}
                                <a href="/static/doctor_credentials/${credentials}" class="btn btn-sm btn-outline-info mt-2" target="_blank">Download Document</a>
                            </div>
                        `;
                    }
                } else {
                    noCredentials.style.display = 'block';
                    credentialsContainer.style.display = 'none';
                    credentialsContainer.innerHTML = '';
                }
                
                // Update modal action buttons
                const modalApproveBtn = document.getElementById('modal-approve-btn');
                const modalRejectBtn = document.getElementById('modal-reject-btn');
                
                // Enable/disable buttons based on current status
                const status = document.querySelector(`tr[data-doctor-id="${doctorId}"] .badge`).textContent.trim();
                
                if (status === 'Pending') {
                    modalApproveBtn.style.display = 'block';
                    modalRejectBtn.style.display = 'block';
                    modalRejectBtn.textContent = 'Reject';
                } else if (status === 'Approved') {
                    modalApproveBtn.style.display = 'none';
                    modalRejectBtn.style.display = 'block';
                    modalRejectBtn.textContent = 'Revoke Approval';
                } else if (status === 'Rejected') {
                    modalApproveBtn.style.display = 'block';
                    modalRejectBtn.style.display = 'none';
                }
                
                // Set up modal approve button
                modalApproveBtn.setAttribute('data-doctor-id', doctorId);
            });
        });
        
        // Approve doctor button (both in table and modal)
        document.querySelectorAll('.approve-doctor, #modal-approve-btn').forEach(button => {
            button.addEventListener('click', function() {
                const doctorId = this.getAttribute('data-doctor-id') || currentDoctorId;
                if (!doctorId) return;
                
                if (confirm('Are you sure you want to approve this doctor?')) {
                    fetch(`/api/doctor/${doctorId}/approve`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Doctor has been approved successfully!');
                            location.reload();
                        } else {
                            alert(`Error: ${data.message || 'Unknown error'}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while approving the doctor.');
                    });
                }
            });
        });
        
        // Reject doctor button (in table)
        document.querySelectorAll('.reject-doctor').forEach(button => {
            button.addEventListener('click', function() {
                const doctorId = this.getAttribute('data-doctor-id');
                const doctorName = this.getAttribute('data-doctor-name');
                
                currentDoctorId = doctorId;
                
                // Update reject modal
                document.getElementById('reject-doctor-name').textContent = doctorName;
            });
        });
        
        // Confirm reject button
        document.getElementById('confirm-reject-btn').addEventListener('click', function() {
            if (!currentDoctorId) return;
            
            const reason = document.getElementById('reject-reason').value.trim();
            
            fetch(`/api/doctor/${currentDoctorId}/reject`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Doctor verification has been rejected.');
                    location.reload();
                } else {
                    alert(`Error: ${data.message || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while rejecting the doctor verification.');
            });
        });
    });
</script>
{% endblock %}