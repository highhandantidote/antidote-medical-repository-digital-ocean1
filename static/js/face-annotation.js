function initAnnotationSystem(){var t=document.querySelector(".structure-diagram"),o=document.querySelector(".facial-analysis-img");if(t&&o){let e=document.querySelector(".annotation-overlay");e||((e=document.createElement("div")).className="annotation-overlay",t.appendChild(e),e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.pointerEvents="none"),addAnnotationsToImage(extractFeaturesFromText(document.querySelectorAll(".analysis-text p")),e,o)}}function extractFeaturesFromText(e){let s=[],r={nose:{region:"center",verticalPosition:"middle"},eyes:{region:"top",verticalPosition:"top"},lips:{region:"bottom",verticalPosition:"bottom"},chin:{region:"bottom",verticalPosition:"bottom"},forehead:{region:"top",verticalPosition:"top"},cheeks:{region:"sides",verticalPosition:"middle"},jaw:{region:"sides",verticalPosition:"bottom"},eyebrows:{region:"top",verticalPosition:"top"},skin:{region:"full",verticalPosition:"full"},symmetry:{region:"full",verticalPosition:"full"},scarring:{region:"custom",verticalPosition:"custom"},wrinkles:{region:"custom",verticalPosition:"custom"},hyperpigmentation:{region:"custom",verticalPosition:"custom"}};return e.forEach(e=>{let i=e.textContent.toLowerCase();Object.keys(r).forEach(t=>{if(i.includes(t)){let e="moderate";i.includes("severe "+t)||i.includes(t+" is severe")?e="severe":(i.includes("mild "+t)||i.includes(t+" is mild"))&&(e="mild");var o={...r[t]},n=(i.includes("left "+t)||i.includes(t+" on the left")?o.horizontal="left":(i.includes("right "+t)||i.includes(t+" on the right"))&&(o.horizontal="right"),extractDescription(i,t));s.push({name:t,severity:e,position:o,description:n})}})}),s}function extractDescription(e,t){var o;for(o of e.split(/[.!?]+/))if(o.includes(t))return o.trim();return""}function addAnnotationsToImage(e,a,t){t.onload=function(){let s=t.offsetWidth,r=t.offsetHeight;a.innerHTML="",e.forEach((e,t)=>{var o=calculatePosition(e.position,s,r),n=document.createElement("div");n.className="annotation-marker "+e.severity,n.style.position="absolute",n.style.left=o.x+"px",n.style.top=o.y+"px",n.style.width="20px",n.style.height="20px",n.style.borderRadius="50%",n.style.border="2px solid #fff",n.style.boxShadow="0 0 5px rgba(0,0,0,0.5)",n.style.zIndex="100",n.style.cursor="pointer",n.style.pointerEvents="auto","mild"===e.severity?n.style.backgroundColor="rgba(255, 235, 59, 0.7)":"moderate"===e.severity?n.style.backgroundColor="rgba(255, 152, 0, 0.7)":"severe"===e.severity&&(n.style.backgroundColor="rgba(244, 67, 54, 0.7)");let i=document.createElement("div");i.className="annotation-tooltip",i.textContent=e.name.charAt(0).toUpperCase()+e.name.slice(1)+(e.description?": "+e.description:""),i.style.position="absolute",i.style.bottom="30px",i.style.left="50%",i.style.transform="translateX(-50%)",i.style.backgroundColor="rgba(0, 0, 0, 0.8)",i.style.color="#fff",i.style.padding="5px 10px",i.style.borderRadius="4px",i.style.fontSize="12px",i.style.width="max-content",i.style.maxWidth="200px",i.style.display="none",i.style.zIndex="101",n.appendChild(i),n.addEventListener("mouseenter",()=>{i.style.display="block"}),n.addEventListener("mouseleave",()=>{i.style.display="none"}),a.appendChild(n)})},t.complete&&t.onload()}function calculatePosition(e,t,o){let n=t/2,i=o/2;return"left"===e.horizontal?n=.25*t:"right"===e.horizontal&&(n=.75*t),"top"===e.verticalPosition?i=.25*o:"bottom"===e.verticalPosition&&(i=.75*o),"nose"===e.region?i=.5*o:"eyes"===e.region?i=.35*o:"lips"===e.region&&(i=.7*o),{x:n,y:i}}function improveTextFormatting(){document.querySelectorAll(".analysis-text").forEach(e=>{e.innerHTML=e.innerHTML.replace(/\*\*\*(.*?)\*\*\*/g,'<h5 class="mt-3 mb-2">$1</h5>'),e.innerHTML=e.innerHTML.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e.innerHTML=e.innerHTML.replace(/\*(.*?)\*/g,"<em>$1</em>"),e.querySelectorAll("p").forEach(e=>{e.style.marginBottom="1rem",e.textContent.includes("Observation:")&&formatSection(e,"Observation:","observation-section"),e.textContent.includes("Treatment Options:")&&formatSection(e,"Treatment Options:","treatment-section"),e.textContent.includes("Expected Outcomes:")&&formatSection(e,"Expected Outcomes:","outcomes-section"),addSeverityIndicators(e)})})}function formatSection(e,t,o){let n=e.innerHTML;n=n.replace(new RegExp(t,"g"),`<div class="${o}"><strong>${t}</strong>`),n+="</div>",e.innerHTML=n}function addSeverityIndicators(e){let o=e.innerHTML;[{term:"mild",class:"text-success",icon:"fa-check-circle"},{term:"moderate",class:"text-warning",icon:"fa-exclamation-circle"},{term:"severe",class:"text-danger",icon:"fa-exclamation-triangle"}].forEach(e=>{var t=new RegExp(`(\\b${e.term}\\b)`,"gi");o=o.replace(t,`<span class="severity-indicator ${e.class}"><i class="fas ${e.icon} me-1"></i>$1</span>`)}),e.innerHTML=o}function addMedicalTermTooltips(){let s={hyperpigmentation:"Darkening of the skin due to excess melanin production",ptosis:"Drooping of the upper eyelid",rhinoplasty:"Surgical procedure to reshape the nose",blepharoplasty:"Surgical procedure to reshape the eyelids","dermal fillers":"Injectable treatments to add volume to facial areas",botox:"Injectable treatment that temporarily weakens muscles to reduce wrinkles","chemical peel":"Treatment that applies a chemical solution to remove damaged skin layers",microdermabrasion:"Procedure that uses tiny crystals to exfoliate the skin surface","fractional laser":"Laser treatment that creates microscopic wounds to stimulate collagen",collagen:"Protein that provides structure and elasticity to the skin",elastin:"Protein that allows tissues to stretch and return to shape",microneedling:"Procedure that creates tiny punctures to stimulate skin healing","hyaluronic acid":"Substance that helps maintain skin hydration",liposuction:"Surgical procedure to remove excess fat"},r=document.querySelector(".facial-assessment-container");r&&Object.keys(s).forEach(i=>{for(var e,t=new RegExp(`\\b${i}\\b`,"gi"),o=document.createTreeWalker(r,NodeFilter.SHOW_TEXT,null,!1),n=[];e=o.nextNode();)t.test(e.nodeValue)&&n.push(e);n.forEach(e=>{var t=e.parentNode;if(!t.classList||!t.classList.contains("medical-term")&&!t.closest(".medical-term")){let n=document.createDocumentFragment();e.nodeValue.split(new RegExp(`(\\b${i}\\b)`,"i")).forEach(t=>{if(t.toLowerCase()===i.toLowerCase()){var o=document.createElement("span");o.className="medical-term",o.textContent=t,o.style.borderBottom="1px dotted #33b5a6",o.style.cursor="help",o.style.position="relative";let e=document.createElement("span");e.className="medical-tooltip",e.textContent=s[i],e.style.position="absolute",e.style.bottom="100%",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.backgroundColor="rgba(0, 0, 0, 0.8)",e.style.color="#fff",e.style.padding="5px 10px",e.style.borderRadius="4px",e.style.fontSize="12px",e.style.width="max-content",e.style.maxWidth="200px",e.style.display="none",e.style.zIndex="1000",o.addEventListener("mouseenter",()=>{e.style.display="block"}),o.addEventListener("mouseleave",()=>{e.style.display="none"}),o.appendChild(e),n.appendChild(o)}else n.appendChild(document.createTextNode(t))}),t.replaceChild(n,e)}})})}document.addEventListener("DOMContentLoaded",function(){initAnnotationSystem(),improveTextFormatting(),addMedicalTermTooltips()});